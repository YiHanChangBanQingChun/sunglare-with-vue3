{"version":3,"file":"js/3573.75dea1bc.js","mappings":"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","sources":["webpack://sun-glare-project/./node_modules/@geoscene/core/views/2d/engine/BitmapContainer.js","webpack://sun-glare-project/./node_modules/@geoscene/core/views/2d/layers/BaseDynamicLayerView2D.js","webpack://sun-glare-project/./node_modules/@geoscene/core/views/2d/viewStateUtils.js","webpack://sun-glare-project/./node_modules/@geoscene/core/views/2d/layers/support/ExportStrategy.js","webpack://sun-glare-project/./node_modules/@geoscene/core/views/layers/RefreshableLayerView.js"],"sourcesContent":["/*\r\nAll material copyright GeoScene, All Rights Reserved, unless otherwise specified.\r\nSee https://js.geoscene.cn/4.27/geoscene/copyright.txt for details.\r\n*/\r\nimport{brushes as e}from\"./brushes.js\";import{WGLDrawPhase as s}from\"./webgl/enums.js\";import r from\"./webgl/WGLContainer.js\";class a extends r{constructor(){super(...arguments),this._hasCrossfade=!1}get requiresDedicatedFBO(){return this._hasCrossfade}beforeRender(e){super.beforeRender(e),this._manageFade()}prepareRenderPasses(r){const a=r.registerRenderPass({name:\"bitmap\",brushes:[e.bitmap],target:()=>this.children,drawPhase:s.MAP});return[...super.prepareRenderPasses(r),a]}_manageFade(){this.children.reduce(((e,s)=>e+(s.inFadeTransition?1:0)),0)>=2?(this.children.forEach((e=>e.blendFunction=\"additive\")),this._hasCrossfade=!0):(this.children.forEach((e=>e.blendFunction=\"standard\")),this._hasCrossfade=!1)}}export{a as BitmapContainer};","/*\r\nAll material copyright GeoScene, All Rights Reserved, unless otherwise specified.\r\nSee https://js.geoscene.cn/4.27/geoscene/copyright.txt for details.\r\n*/\r\nimport{_ as t}from\"../../../chunks/tslib.es6.js\";import e from\"../../../core/Logger.js\";import{isAbortError as r}from\"../../../core/promiseUtils.js\";import{property as s}from\"../../../core/accessorSupport/decorators/property.js\";import\"../../../core/accessorSupport/ensureType.js\";import\"../../../core/arrayUtils.js\";import\"../../../core/has.js\";import{subclass as i}from\"../../../core/accessorSupport/decorators/subclass.js\";import{BitmapContainer as a}from\"../engine/BitmapContainer.js\";import{LayerView2DMixin as o}from\"./LayerView2D.js\";import p from\"./support/ExportStrategy.js\";import n from\"../../layers/LayerView.js\";import m from\"../../layers/RefreshableLayerView.js\";let h=class extends(m(o(n))){update(t){this._strategy.update(t).catch((t=>{r(t)||e.getLogger(this).error(t)})),this.notifyChange(\"updating\")}attach(){this._bitmapContainer=new a,this.container.addChild(this._bitmapContainer),this._strategy=new p({container:this._bitmapContainer,fetchSource:this.fetchBitmapData.bind(this),requestUpdate:this.requestUpdate.bind(this)})}detach(){this._strategy.destroy(),this._strategy=null,this.container.removeChild(this._bitmapContainer),this._bitmapContainer.removeAllChildren()}moveStart(){}viewChange(){}moveEnd(){this.requestUpdate()}fetchBitmapData(t,e,r){return this.layer.fetchImageBitmap(t,e,r)}async doRefresh(){this.requestUpdate()}isUpdating(){return this._strategy.updating||this.updateRequested}};t([s()],h.prototype,\"_strategy\",void 0),t([s()],h.prototype,\"updating\",void 0),h=t([i(\"geoscene.views.2d.layers.BaseDynamicLayerView2D\")],h);const c=h;export{c as default};","/*\r\nAll material copyright GeoScene, All Rights Reserved, unless otherwise specified.\r\nSee https://js.geoscene.cn/4.27/geoscene/copyright.txt for details.\r\n*/\r\nconst t=Math.PI/180;function n(n){return n*t}function o(t,o){const a=n(o.rotation),r=Math.abs(Math.cos(a)),s=Math.abs(Math.sin(a)),[u,c]=o.size;return t[0]=Math.round(c*s+u*r),t[1]=Math.round(c*r+u*s),t}function a(t,n,o,a){const[r,s]=n,[u,c]=a,h=.5*o;return t[0]=r-h*u,t[1]=s-h*c,t[2]=r+h*u,t[3]=s+h*c,t}export{a as getBBox,o as getOuterSize};","/*\r\nAll material copyright GeoScene, All Rights Reserved, unless otherwise specified.\r\nSee https://js.geoscene.cn/4.27/geoscene/copyright.txt for details.\r\n*/\r\nimport{_ as t}from\"../../../../chunks/tslib.es6.js\";import e from\"../../../../core/Accessor.js\";import\"../../../../core/has.js\";import{debounce as i,throwIfAborted as o,throwIfAbortError as r,eachAlways as s}from\"../../../../core/promiseUtils.js\";import{property as a}from\"../../../../core/accessorSupport/decorators/property.js\";import\"../../../../core/accessorSupport/ensureType.js\";import\"../../../../core/arrayUtils.js\";import{subclass as p}from\"../../../../core/accessorSupport/decorators/subclass.js\";import{create as n,toExtent as m}from\"../../../../geometry/support/aaBoundingRect.js\";import{getInfo as l}from\"../../../../geometry/support/spatialReferenceUtils.js\";import h from\"../../../../layers/support/TileInfo.js\";import{getOuterSize as d,getBBox as c}from\"../../viewStateUtils.js\";import{Bitmap as u}from\"../../engine/Bitmap.js\";import g from\"../../tiling/TileInfoView.js\";import f from\"../../tiling/TileKey.js\";const y=n(),x=[0,0],S=new f(0,0,0,0),_={container:null,fetchSource:null,requestUpdate:null,imageMaxWidth:2048,imageMaxHeight:2048,imageRotationSupported:!1,imageNormalizationSupported:!1,hidpi:!1};let w=class extends e{constructor(t){super(t),this._imagePromise=null,this.bitmaps=[],this.hidpi=_.hidpi,this.imageMaxWidth=_.imageMaxWidth,this.imageMaxHeight=_.imageMaxHeight,this.imageRotationSupported=_.imageRotationSupported,this.imageNormalizationSupported=_.imageNormalizationSupported,this.update=i((async(t,e)=>{if(o(e),!t.stationary||this.destroyed)return;const i=t.state,s=l(i.spatialReference),a=this.hidpi?t.pixelRatio:1,p=this.imageNormalizationSupported&&i.worldScreenWidth&&i.worldScreenWidth<i.size[0],n=this.imageMaxWidth??0,m=this.imageMaxHeight??0;p?(x[0]=i.worldScreenWidth,x[1]=i.size[1]):this.imageRotationSupported?(x[0]=i.size[0],x[1]=i.size[1]):d(x,i);const h=Math.floor(x[0]*a)>n||Math.floor(x[1]*a)>m,c=s&&(i.extent.xmin<s.valid[0]||i.extent.xmax>s.valid[1]),u=!this.imageNormalizationSupported&&c,g=!h&&!u,f=this.imageRotationSupported?i.rotation:0,y=this.container.children.slice();if(g){const t=p?i.paddedViewState.center:i.center;this._imagePromise&&console.error(\"Image promise was not defined!\"),this._imagePromise=this._singleExport(i,x,t,i.resolution,f,a,e)}else{let t=Math.min(n,m);u&&(t=Math.min(i.worldScreenWidth,t)),this._imagePromise=this._tiledExport(i,t,a,e)}try{const t=await this._imagePromise??[];o(e);const i=[];if(this._imagePromise=null,this.destroyed)return;this.bitmaps=t;for(const e of y)t.includes(e)||i.push(e.fadeOut().then((()=>{e.remove(),e.destroy()})));for(const e of t)i.push(e.fadeIn());await Promise.all(i)}catch(S){this._imagePromise=null,r(S)}}),5e3),this.updateExports=i((async t=>{const e=[];for(const i of this.container.children){if(!i.visible||!i.stage)return;e.push(t(i).then((()=>{i.invalidateTexture(),i.requestRender()})))}this._imagePromise=s(e).then((()=>this._imagePromise=null)),await this._imagePromise}))}destroy(){this.bitmaps.forEach((t=>t.destroy())),this.bitmaps=[]}get updating(){return!this.destroyed&&null!==this._imagePromise}async _export(t,e,i,r,s,a){const p=await this.fetchSource(t,Math.floor(e*s),Math.floor(i*s),{rotation:r,pixelRatio:s,signal:a});o(a);const n=new u(null,!0);return n.x=t.xmin,n.y=t.ymax,n.resolution=t.width/e,n.rotation=r,n.pixelRatio=s,n.opacity=0,this.container.addChild(n),await n.setSourceAsync(p,a),o(a),n}async _singleExport(t,e,i,o,r,s,a){c(y,i,o,e);const p=m(y,t.spatialReference);return[await this._export(p,e[0],e[1],r,s,a)]}_tiledExport(t,e,i,o){const r=h.create({size:e,spatialReference:t.spatialReference,scales:[t.scale]}),s=new g(r),a=s.getTileCoverage(t);if(!a)return null;const p=[];return a.forEach(((r,a,n,l)=>{S.set(r,a,n,0),s.getTileBounds(y,S);const h=m(y,t.spatialReference);p.push(this._export(h,e,e,0,i,o).then((t=>(0!==l&&(S.set(r,a,n,l),s.getTileBounds(y,S),t.x=y[0],t.y=y[3]),t))))})),Promise.all(p)}};t([a()],w.prototype,\"_imagePromise\",void 0),t([a()],w.prototype,\"bitmaps\",void 0),t([a()],w.prototype,\"container\",void 0),t([a()],w.prototype,\"fetchSource\",void 0),t([a()],w.prototype,\"hidpi\",void 0),t([a()],w.prototype,\"imageMaxWidth\",void 0),t([a()],w.prototype,\"imageMaxHeight\",void 0),t([a()],w.prototype,\"imageRotationSupported\",void 0),t([a()],w.prototype,\"imageNormalizationSupported\",void 0),t([a()],w.prototype,\"requestUpdate\",void 0),t([a()],w.prototype,\"updating\",null),w=t([p(\"geoscene.views.2d.layers.support.ExportStrategy\")],w);const v=w;export{v as default};","/*\r\nAll material copyright GeoScene, All Rights Reserved, unless otherwise specified.\r\nSee https://js.geoscene.cn/4.27/geoscene/copyright.txt for details.\r\n*/\r\nimport{_ as r}from\"../../chunks/tslib.es6.js\";import e from\"../../core/Logger.js\";import{isAbortError as s}from\"../../core/promiseUtils.js\";import{on as o}from\"../../core/reactiveUtils.js\";import{property as t}from\"../../core/accessorSupport/decorators/property.js\";import\"../../core/accessorSupport/ensureType.js\";import\"../../core/arrayUtils.js\";import\"../../core/has.js\";import{subclass as i}from\"../../core/accessorSupport/decorators/subclass.js\";const a=a=>{let c=class extends a{initialize(){this.handles.add(o((()=>this.layer),\"refresh\",(r=>{this.doRefresh(r.dataChanged).catch((r=>{s(r)||e.getLogger(this).error(r)}))})),\"RefreshableLayerView\")}};return r([t()],c.prototype,\"layer\",void 0),c=r([i(\"geoscene.layers.mixins.RefreshableLayerView\")],c),c};export{a as default};"],"names":["a","r","constructor","super","arguments","this","_hasCrossfade","requiresDedicatedFBO","beforeRender","e","_manageFade","prepareRenderPasses","registerRenderPass","name","brushes","bitmap","target","children","drawPhase","s","MAP","reduce","inFadeTransition","forEach","blendFunction","h","m","o","n","update","t","_strategy","catch","getLogger","error","notifyChange","attach","_bitmapContainer","container","addChild","p","fetchSource","fetchBitmapData","bind","requestUpdate","detach","destroy","removeChild","removeAllChildren","moveStart","viewChange","moveEnd","layer","fetchImageBitmap","doRefresh","isUpdating","updating","updateRequested","prototype","i","c","Math","PI","rotation","abs","cos","sin","u","size","round","y","x","S","f","_","imageMaxWidth","imageMaxHeight","imageRotationSupported","imageNormalizationSupported","hidpi","w","_imagePromise","bitmaps","async","stationary","destroyed","state","l","spatialReference","pixelRatio","worldScreenWidth","d","floor","extent","xmin","valid","xmax","g","slice","paddedViewState","center","console","_singleExport","resolution","min","_tiledExport","includes","push","fadeOut","then","remove","fadeIn","Promise","all","updateExports","visible","stage","invalidateTexture","requestRender","_export","signal","ymax","width","opacity","setSourceAsync","create","scales","scale","getTileCoverage","set","getTileBounds","v","initialize","handles","add","dataChanged"],"sourceRoot":""}