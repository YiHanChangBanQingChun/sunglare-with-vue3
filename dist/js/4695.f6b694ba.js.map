{"version":3,"file":"js/4695.f6b694ba.js","mappings":"kRAIqO,MAAMA,EAAE,IAAIC,EAAE,GAAGD,EAAEE,EAAE,IAAIC,EAAE,EAAEC,eAAeC,GAAGC,KAAKD,EAAEE,KAAKC,EAAEC,YAAYC,GAAGC,EAAEC,GAAG,IAAIC,EAAE,KAAK,IAAI,MAAMC,GAAEC,EAAAA,EAAAA,IAAEJ,EAAE,WAAWK,GAAED,EAAAA,EAAAA,IAAED,EAAE,SAASR,KAAKW,SAASC,EAAAA,EAAAA,YAAEF,EAAE,CAACG,MAAM,CAACN,EAAE,QAAQO,aAAa,UAASC,EAAAA,EAAAA,IAAET,GAAG,MAAMU,GAAEC,EAAAA,EAAAA,IAAEZ,GAAGa,EAAEP,EAAEQ,kBAAkBzB,EAAE0B,EAAEJ,EAAEpB,EAAEsB,EAAEG,EAAEL,EAAEM,KAAKC,IAAI5B,EAAEuB,GAAGvB,EAAE,GAAGI,EAAEyB,KAAKJ,EAAE,MAAM,IAAIK,MAAM,kBAAkB,MAAMC,GAAEjB,EAAAA,EAAAA,IAAED,EAAE,aAAaR,KAAK2B,SAASf,EAAAA,EAAAA,YAAEc,EAAE,CAACb,MAAM,CAACN,EAAE,OAAOqB,SAAS1B,EAAEC,YAAYC,GAAGU,aAAa,OAAOe,OAAO,SAAS,IAAGd,EAAAA,EAAAA,IAAET,IAAIqB,EAAEG,QAAQ,MAAM,IAAIL,MAAM,uBAAuB,MAAMM,OAAOC,GAAGL,EAAEM,KAAK1B,GAAEE,EAAAA,EAAAA,IAAED,EAAEwB,GAAG,MAAME,GAAEzB,EAAAA,EAAAA,IAAEF,EAAE,cAAc4B,EAAEb,KAAKc,KAAKrC,EAAEyB,KAAKH,GAAGgB,EAAE,IAAIC,MAAM,IAAI,IAAI1B,EAAE,EAAEA,EAAEuB,IAAIvB,EAAEyB,EAAEE,KAAKxC,EAAEyC,MAAM5B,EAAES,EAAEC,KAAKC,KAAKX,EAAE,GAAGS,EAAEtB,EAAEyB,QAAQ,MAAMiB,EAAEJ,EAAEG,QAAQE,UAAUC,EAAE,IAAIL,MAAMM,EAAE9C,UAAU,KAAK,IAAI2C,EAAEI,QAAQ,CAAC,MAAMpC,EAAE4B,EAAEQ,OAAOJ,EAAEI,OAAO5B,EAAEwB,EAAEK,MAAMpD,EAAE,IAAIqD,SAASrD,EAAEsD,OAAO,IAAI,QAAQtD,EAAEsD,OAAO,OAAO/B,GAAGvB,EAAEsD,OAAO,SAAS,GAAGvC,KAAK,MAAMT,KAAKL,SAASiB,EAAAA,EAAAA,YAAEsB,EAAE,CAACe,QAAQ,EAAEC,KAAKxD,EAAEoB,aAAa,OAAOe,OAAO,SAAS,IAAGd,EAAAA,EAAAA,IAAET,IAAIX,EAAEmC,QAAQ,MAAM,IAAIL,MAAM,qBAAqB,GAAG,IAAI,IAAIb,EAAE,EAAEA,EAAEf,GAAG,IAAI4C,EAAEI,SAASjC,EAAE+B,EAAEJ,KAAKK,WAAWO,QAAQC,IAAIT,GAAG,MAAMU,GAAE5C,EAAAA,EAAAA,IAAEF,EAAE,WAAWP,KAAKsD,SAAS1C,EAAAA,EAAAA,YAAEyC,EAAE,CAACxC,MAAM,CAACN,EAAE,OAAOgD,MAAMlB,EAAEmB,KAAK,CAAC5C,EAAEG,IAAIA,IAAI0C,KAAK,MAAM3C,aAAa,OAAOe,OAAO,SAAS,IAAGd,EAAAA,EAAAA,IAAET,IAAIgD,EAAExB,QAAQ,MAAM,IAAIL,MAAM,iBAAiB,OAAO6B,EAAErB,IAAI,CAAC,MAAMzB,GAAG,GAAG,MAAMD,EAAE,CAAC,MAAMQ,GAAEN,EAAAA,EAAAA,IAAEF,EAAE,gBAAgBK,EAAAA,EAAAA,YAAEG,EAAE,CAACF,MAAM,CAACN,EAAE,QAAQO,aAAa,OAAOe,OAAO,QAAQ,CAAC,MAAMrB,CAAC,CAAC,C,eCAz3BV,eAAesB,EAAER,EAAEG,EAAEE,GAAG,OAAOL,EAAEiC,OAAOM,QAAQC,IAAIxC,EAAE4C,KAAK5C,GAAGc,EAAEd,EAAEG,EAAEE,MAAM,EAAE,CAACnB,eAAe4B,EAAEd,GAAG8C,MAAMzC,EAAE0C,eAAejE,GAAGC,GAAG,MAAMc,EAAEf,EAAEkE,IAAIhD,GAAG,GAAGH,EAAE,OAAOA,EAAE,IAAIgC,EAAExB,GAAG,MAAM,IAAIF,EAAAA,EAAE,GAAGE,EAAE4C,4BAA4B,wCAAwC,IAAIpC,OAAO,GAAGqC,EAAElD,EAAEK,GAAG,OAAOL,EAAE,MAAMhB,EAAEoC,EAAEpB,EAAEK,EAAEtB,GAAGD,EAAEqE,IAAInD,EAAEhB,GAAG,UAAUA,CAAC,CAAC,QAAQF,EAAEsE,OAAOpD,EAAE,CAAC,OAAOA,CAAC,CAAC,SAASkD,EAAElD,EAAEG,GAAG,MAAMkD,UAAUhD,GAAGF,EAAE,OAAO,MAAME,GAAGL,EAAEsD,SAASC,gBAAgBC,MAAMxD,IAAGR,EAAAA,EAAAA,IAAEQ,EAAEK,IAAI,CAACnB,eAAekC,EAAEpB,EAAEG,EAAEE,GAAG,MAAMiD,SAASvE,GAAGiB,GAAGyD,cAAc5D,GAAGd,EAAEC,EAAE+C,EAAElC,GAAG6D,OAAOvD,GAAGlB,IAAID,EAAEY,EAAEb,EAAEwE,gBAAgBtB,OAAO,EAAEzC,EAAEP,EAAE0E,EAAE3E,EAAEmB,EAAEE,GAAGT,EAAE6C,EAAEzC,EAAEG,EAAEE,GAAGC,EAAEN,EAAEG,EAAEE,GAAGf,QAAQE,EAAE,OAAOV,EAAAA,EAAAA,IAAEuB,GAAGL,EAAE4D,mBAAmB,CAACtE,IAAIU,CAAC,CAACd,eAAeyE,EAAE3D,EAAEG,EAAEE,GAAG,MAAM,CAACqD,aAAaG,EAAE7D,EAAEG,EAAEE,GAAGyD,UAAS,EAAG,CAAC5E,eAAeuD,EAAEzC,EAAEK,EAAEvB,GAAG,MAAMC,EAAEgF,EAAE1D,IAAIkD,gBAAgB1D,GAAGG,EAAEsD,SAAStE,EAAEsC,EAAEzB,EAAEQ,GAAG,IAAIrB,EAAE,MAAM,IAAImB,EAAAA,EAAE,GAAGE,EAAE4C,4BAA4B,sEAAsE,IAAIpC,OAAO,MAAM5B,QAAQ4E,EAAE7E,EAAEqB,EAAEvB,GAAkD,OAA/CkB,EAAE4D,mBAAmB,CAAC,CAACF,OAAOzE,EAAE6E,UAAS,KAAY,CAACJ,aAAajD,EAAExB,EAAEoB,EAAEtB,GAAG,CAACG,eAAeoB,EAAEN,EAAEG,EAAEE,GAAG,MAAMvB,EAAEyC,EAAEvB,EAAEG,EAAEE,GAAG,MAAM,CAACqD,aAAa1B,EAAE,CAAClD,GAAGqB,EAAEE,GAAG2D,OAAOhE,EAAEgE,OAAOC,QAAQH,UAAS,EAAG,CAAC5E,eAAeqC,EAAEvB,EAAEG,EAAEE,GAAG,MAAMtB,EAAEgF,EAAE5D,GAAGN,QAAQG,EAAEkE,KAAK7D,GAAGrB,QAAQa,EAAEsE,aAAa,CAACC,sBAAqB,KAAKtF,EAAAA,EAAAA,IAAEuB,GAAG,MAAMpB,QAAQD,EAAEqF,SAAS,OAAOvF,EAAAA,EAAAA,IAAEuB,GAAG,CAACiE,KAAK,IAAIC,KAAK,CAACtF,EAAEG,MAAM,CAAC6D,KAAKhE,EAAEgE,OAAOuB,UAAU,IAAG5E,EAAAA,EAAAA,WAAU6E,UAAU1F,EAAE,CAAC,SAASuC,EAAEtB,EAAEG,GAAG,IAAI,MAAME,KAAKL,EAAE,CAAC,MAAMA,EAAE+B,EAAE1B,EAAEqD,OAAOvD,GAAG,GAAGH,EAAE,OAAOA,CAAC,CAAC,OAAO,IAAI,CAAC,SAAS+B,EAAE/B,EAAEG,GAAG,IAAIH,EAAE,OAAO,KAAK,MAAM0E,WAAWC,iBAAiBtE,EAAEuE,YAAY9F,IAAIqB,EAAEpB,GAAEW,EAAAA,EAAAA,IAAEM,GAAGH,EAAE,IAAI6B,MAAM,IAAI1C,GAAE,EAAG,IAAI,IAAIC,EAAE,EAAEA,EAAEF,EAAEkD,SAAShD,EAAE,CAAC,MAAMe,EAAE6E,EAAE9F,EAAEE,GAAGoB,GAAG,IAAIL,EAAE,OAAO,KAAKlB,EAAEgG,SAAS9E,EAAEyE,aAAazF,GAAE,GAAIa,EAAE8B,KAAK3B,EAAE,CAAC,OAAOhB,EAAEa,EAAE,IAAI,CAAC,SAASgF,EAAE7E,EAAEG,GAAG,MAAME,GAAEf,EAAAA,EAAAA,IAAEU,EAAEG,GAAG,OAAOE,EAAE,CAAC0E,MAAM/E,EAAEyE,UAAUpE,GAAG,IAAI,CAACnB,eAAe2E,EAAE7D,EAAEG,EAAEE,GAAG,OAAO2B,EAAEhC,EAAE4C,KAAK5C,GAAGgF,EAAEhF,EAAEK,KAAKF,EAAEE,EAAE,CAACnB,eAAe8C,EAAEhC,EAAEG,EAAEE,GAAG,MAAMtB,QAAQwD,QAAQC,IAAIxC,EAAE4C,KAAK1D,UAAU,MAAMH,EAAE2D,QAAQ1C,EAAEG,EAAEE,GAAG,OAAOvB,EAAAA,EAAAA,IAAEuB,GAAGtB,CAAC,MAAKD,EAAAA,EAAAA,IAAEuB,GAAG,MAAM4E,cAAcpF,SAASqF,EAAEnG,EAAE6D,KAAK,EAAEvB,KAAKrB,KAAKA,IAAIG,EAAEE,GAAG,OAAOvB,EAAAA,EAAAA,IAAEuB,GAAGL,EAAE4C,KAAK,CAAC5C,EAAEK,IAAI8E,EAAEpG,EAAEsB,GAAGR,EAAEQ,GAAGF,IAAI,CAACjB,eAAe8F,EAAEhF,EAAEG,GAAG,MAAM4E,MAAM1E,EAAEoE,UAAU1F,GAAGiB,EAAE,GAAGK,aAAa+E,KAAK,MAAM,CAACd,KAAKjE,EAAEmE,UAAUnE,EAAEhB,KAAKoF,UAAU1F,GAAG,MAAMc,QAAQQ,EAAEgF,OAAOlF,GAAG,OAAOrB,EAAAA,EAAAA,IAAEqB,GAAG,CAACmE,KAAKzE,EAAE2E,UAAUnE,EAAEmE,UAAUC,UAAU1F,EAAE,CAACG,eAAewD,EAAE1C,EAAEH,EAAEZ,GAAG,MAAMqF,KAAK1E,EAAE6E,UAAUjF,EAAEgF,UAAUlF,GAAGU,EAAE,IAAIb,EAAE,KAAK,IAAI,MAAMa,QAAQP,EAAE,CAACL,KAAKQ,EAAEP,KAAKC,GAAGO,EAAEyF,IAAIrG,IAAGH,EAAAA,EAAAA,IAAEG,GAAGE,EAAE,CAACsF,UAAUjF,EAAE+F,cAAcvF,EAAEmB,OAAO,CAAC,MAAMxB,IAAGZ,EAAAA,EAAAA,IAAEY,GAAGU,EAAAA,EAAEmF,UAAU,yDAAyDC,SAAS,WAAW5F,EAAEyF,6CAA6C,CAAC,IAAInG,EAAE,CAAC,MAAMa,QAAQhB,EAAAA,EAAAA,IAAEY,GAAG,IAAGd,EAAAA,EAAAA,IAAEG,IAAIe,EAAE0F,SAAS,MAAM,IAAIvF,EAAAA,EAAE,GAAGN,EAAEoD,kCAAkC,wDAAwD,IAAIpC,OAAO1B,EAAE,CAACsF,UAAUjF,EAAEmG,UAAU3F,EAAEZ,KAAK,CAAC,IAAID,EAAE,MAAM,IAAIgB,EAAAA,EAAE,GAAGN,EAAEoD,kCAAkC,iDAAiD,IAAIpC,OAAO,MAAM,CAACQ,KAAKlC,EAAEqF,UAAUlF,EAAE,CAACJ,eAAegG,EAAE7E,EAAEtB,EAAEc,GAAG,MAAMb,QAAQgB,EAAAA,EAAAA,aAAEf,EAAAA,EAAAA,IAAEF,EAAEsE,UAAUuC,KAAK,gBAAgB,CAACvD,QAAQ,EAAEpC,MAAM,CAACN,EAAE,OAAOkG,OAAOC,KAAKC,UAAU1F,IAAIY,OAAO,OAAOf,aAAa,SAAS,IAAGpB,EAAAA,EAAAA,IAAEe,GAAGb,EAAEI,KAAK6F,cAAchD,SAAS5B,EAAE4B,OAAO,MAAM,IAAI9B,EAAAA,EAAE,GAAGpB,EAAEkE,kCAAkC,0BAA0B5C,EAAE4B,6BAA6BjD,EAAEI,KAAK6F,cAAchD,kBAAkB,IAAIpB,OAAO,OAAO7B,EAAEI,IAAI,CAAC,SAAS+F,EAAEnF,EAAEK,EAAEvB,GAAG,MAAMoC,QAAQnC,GAAGsB,EAAE,IAAItB,EAAE,CAAC,MAAMiH,MAAMjH,GAAGsB,EAAE,MAAM,IAAIF,EAAAA,EAAE,GAAGrB,EAAEmE,4BAA4B,8BAA8BjD,EAAEwE,0BAA0BzF,EAAEkH,wBAAwBlH,EAAEmH,WAAW,IAAIrF,MAAM,CAAC,MAAMsF,UAAUtG,GAAGQ,GAAGmE,UAAUxF,EAAEqC,MAAMoD,UAAUxF,IAAIe,GAAG0E,WAAWC,iBAAiB/E,IAAId,EAAEU,GAAEY,EAAAA,EAAAA,IAAEnB,EAAEW,GAAG,IAAIJ,EAAE,MAAM,IAAIW,EAAAA,EAAE,GAAGrB,EAAEmE,4BAA4B,yDAAyDhE,uDAAuD,IAAI4B,OAAO,OAAO,IAAI1B,EAAAA,GAAEH,EAAEQ,EAAE,CAAC,IAAIG,EAAAA,GAAE,GAAGb,EAAEuE,UAAUuC,eAAe/F,IAAIA,IAAI,CAACX,eAAeuB,EAAEJ,EAAEvB,EAAEC,GAAG,MAAMc,EAAEQ,EAAEuC,KAAK,EAAE4B,UAAUxE,EAAE2C,MAAMxC,MAAE,CAAKqE,UAAUxE,EAAEmG,UAAUhG,EAAE,GAAGiG,aAAapH,EAAEF,EAAEuH,cAAcC,WAAWC,uBAAuB3G,EAAE,CAACK,MAAM,CAACN,EAAE,OAAOkG,OAAOC,KAAKC,UAAUlG,GAAG2G,cAAc,uBAAuBC,aAAa1H,EAAEG,MAAMF,GAAGkB,aAAa,OAAOmC,QAAQ,GAAG7C,GAAEP,EAAAA,EAAAA,IAAEH,EAAEuE,UAAUuC,KAAK,aAAatG,GAAGN,QAAQ0H,EAAElH,EAAEI,SAASI,EAAAA,EAAAA,YAAER,EAAEI,IAAIR,MAAMsF,WAAWC,iBAAiBjF,IAAIZ,EAAE,OAAOQ,EAAEuG,OAAOjD,KAAK5C,IAAI,MAAMK,GAAEN,EAAAA,EAAAA,IAAEC,EAAE2G,YAAYjH,GAAG,IAAIW,EAAE,MAAM,IAAIF,EAAAA,EAAE,GAAGrB,EAAEmE,4BAA4B,yDAAyD5C,uDAAuD,IAAIQ,OAAO,OAAO,IAAI1B,EAAAA,GAAEa,EAAEwE,UAAUxE,EAAE2G,YAAY,CAAC,IAAIhH,EAAAA,GAAEK,EAAE4G,SAAS5G,EAAEmG,YAAY,GAAG,CAACjH,eAAewH,EAAErG,EAAEvB,GAAG,MAAMC,SAASiB,EAAAA,EAAAA,YAAEK,EAAEvB,IAAIM,KAAKyH,UAAU,OAAO,CAAC,MAAMxG,SAASL,EAAAA,EAAAA,YAAEjB,EAAE,CAACkB,MAAM,CAACN,EAAE,QAAQO,aAAa,UAAUd,KAAK,OAAOiB,EAAEyG,QAAQ,IAAI,YAAY,OAAO9G,EAAAA,EAAAA,YAAEK,EAAE0G,UAAU,CAAC9G,MAAM,CAACN,EAAE,QAAQO,aAAa,SAAS,IAAI,sBAAsB,MAAM,IAAIC,EAAAA,EAAE,yBAAyB,uCAAuC,IAAI,uBAAuB,IAAI,aAAa,IAAI,UAAU,IAAI,oBAAoB,IAAI,gBAAgB,IAAI,gBAAgB,IAAI,oBAAoB,IAAI,oBAAoB,IAAI,sBAAsB,IAAI,uBAAuB,MAAM,QAAQ,MAAM,IAAIA,EAAAA,EAAE,yBAAyB,wEAAwEN,EAAAA,EAAAA,IAAEmH,EAAE,CAAC,CAAC,SAASnF,EAAE7B,GAAG,QAAQA,EAAE0E,aAAa1E,EAAEsF,GAAG,CAAC,SAASvB,EAAE/D,GAAG,MAAM0E,UAAUrE,GAAGL,EAAElB,GAAEiB,EAAAA,EAAAA,IAAE,oBAAoBM,EAAEsE,oBAAmB7E,EAAAA,EAAAA,IAAE,MAAMO,EAAEsE,kBAAkB,IAAI7F,EAAE,MAAM,IAAIqB,EAAAA,EAAE,GAAGH,EAAEiD,4BAA4B,8BAA8B,IAAIpC,OAAO,OAAO/B,CAAC,CAAC,MAAMkI,EAAE,G","sources":["webpack://sun-glare-project/./node_modules/@geoscene/core/layers/graphics/sources/support/uploads.js","webpack://sun-glare-project/./node_modules/@geoscene/core/layers/graphics/sources/support/uploadAssets.js"],"sourcesContent":["/*\r\nAll material copyright GeoScene, All Rights Reserved, unless otherwise specified.\r\nSee https://js.geoscene.cn/4.27/geoscene/copyright.txt for details.\r\n*/\r\nimport e from\"../../../../request.js\";import{throwIfAborted as t}from\"../../../../core/promiseUtils.js\";import{join as o}from\"../../../../core/urlUtils.js\";import{isHostedAgolService as s}from\"../../../support/arcgisLayerUrl.js\";const r=1e6,a=20*r,n=2e9,i=3;async function p({data:p,name:c,description:l},m,d){let f=null;try{const u=o(m,\"uploads\"),h=o(u,\"info\"),{data:w}=await e(h,{query:{f:\"json\"},responseType:\"json\"});t(d);const y=s(m),j=w.maxUploadFileSize*r,g=y?n:j,q=y?Math.min(a,j):a;if(p.size>g)throw new Error(\"Data too large\");const T=o(u,\"register\"),{data:z}=await e(T,{query:{f:\"json\",itemName:c,description:l},responseType:\"json\",method:\"post\"});if(t(d),!z.success)throw new Error(\"Registration failed\");const{itemID:E}=z.item;f=o(u,E);const U=o(f,\"uploadPart\"),D=Math.ceil(p.size/q),M=new Array;for(let e=0;e<D;++e)M.push(p.slice(e*q,Math.min((e+1)*q,p.size)));const P=M.slice().reverse(),x=new Array,A=async()=>{for(;0!==P.length;){const o=M.length-P.length,s=P.pop(),r=new FormData;r.append(\"f\",\"json\"),r.append(\"file\",s),r.append(\"partId\",`${o}`);const{data:a}=await e(U,{timeout:0,body:r,responseType:\"json\",method:\"post\"});if(t(d),!a.success)throw new Error(\"Part upload failed\")}};for(let e=0;e<i&&0!==P.length;++e)x.push(A());await Promise.all(x);const F=o(f,\"commit\"),{data:I}=await e(F,{query:{f:\"json\",parts:M.map(((e,t)=>t)).join(\",\")},responseType:\"json\",method:\"post\"});if(t(d),!I.success)throw new Error(\"Commit failed\");return I.item}catch(u){if(null!=f){const t=o(f,\"delete\");await e(t,{query:{f:\"json\"},responseType:\"json\",method:\"post\"})}throw u}}export{p as uploadItem};","/*\r\nAll material copyright GeoScene, All Rights Reserved, unless otherwise specified.\r\nSee https://js.geoscene.cn/4.27/geoscene/copyright.txt for details.\r\n*/\r\nimport e from\"../../../../request.js\";import t from\"../../../../core/Error.js\";import s from\"../../../../core/Logger.js\";import{throwIfAborted as r,throwIfAbortError as a,after as o}from\"../../../../core/promiseUtils.js\";import{parseData as n,join as i}from\"../../../../core/urlUtils.js\";import{generateBracedUUID as u}from\"../../../../core/uuid.js\";import{externalIsOnService as l,assetFormatId as c,ServiceAsset as p,ServiceAssetPart as f,externalSourceToMultiPart as d}from\"../../../../geometry/support/meshUtils/External.js\";import{uploadItem as m}from\"./uploads.js\";import{getFormatIdMimeType as y,getMimeTypeFormatId as w,getFilenameFormatId as h}from\"../../../support/infoFor3D.js\";async function g(e,t,s){return e.length?Promise.all(e.map((e=>T(e,t,s)))):[]}async function T(e,{layer:s,ongoingUploads:r},a){const o=r.get(e);if(o)return o;if(!P(s))throw new t(`${s.type}-layer:upload-failure`,\"Layer does not support asset uploads.\",new Error);if(b(e,s))return e;const n=E(e,s,a);r.set(e,n);try{await n}finally{r.delete(e)}return e}function b(e,t){const{parsedUrl:s}=t;return null!=s&&e.metadata.externalSources.some((e=>l(e,s)))}async function E(e,t,s){const{metadata:a}=e,{displaySource:o}=a,n=x(o?.source,t),i=!!n,u=a.externalSources.length>0,l=i?$(n,t,s):u?F(e,t,s):j(e,t,s),c=await l;return r(s),e.addExternalSources([c]),e}async function $(e,t,s){return{source:await N(e,t,s),original:!0}}async function F(e,s,r){const a=B(s),{externalSources:o}=e.metadata,n=U(o,s);if(!n)throw new t(`${s.type}-layer:upload-failure`,\"Could not find an external source that is supported by the service.\",new Error);const i=await N(n,s,r);e.addExternalSources([{source:i,original:!0}]);return{source:await q(i,s,a)}}async function j(e,t,s){const r=D(e,t,s);return{source:await A([r],t,s),extent:e.extent.clone(),original:!0}}async function D(e,t,s){const a=B(t),o=await e.load(s),n=await o.toBinaryGLTF({ignoreLocalTransform:!0});r(s);const i=await n.buffer();return r(s),{blob:new Blob([i.data],{type:i.type}),assetName:`${u()}.glb`,assetType:a}}function U(e,t){for(const s of e){const e=x(s.source,t);if(e)return e}return null}function x(e,t){if(!e)return null;const{infoFor3D:{supportedFormats:s,editFormats:r}}=t,a=d(e),o=new Array;let n=!1;for(let i=0;i<a.length;++i){const e=v(a[i],s);if(!e)return null;r.includes(e.assetType)&&(n=!0),o.push(e)}return n?o:null}function v(e,t){const s=c(e,t);return s?{asset:e,assetType:s}:null}async function N(e,t,s){return A(e.map((e=>S(e,s))),t,s)}async function A(e,t,s){const a=await Promise.all(e.map((async e=>{const a=I(await e,t,s);return r(s),a})));r(s);const{uploadResults:o}=await R(a.map((({item:e})=>e)),t,s);return r(s),e.map(((e,s)=>L(a[s],o[s],t)))}async function S(e,t){const{asset:s,assetType:a}=e;if(s instanceof File)return{blob:s,assetName:s.name,assetType:a};const o=await s.toBlob(t);return r(t),{blob:o,assetName:s.assetName,assetType:a}}async function I(e,o,i){const{blob:u,assetType:l,assetName:c}=e;let p=null;try{const e=await m({data:u,name:c},o.url,i);r(i),p={assetType:l,assetUploadId:e.itemID}}catch(f){a(f),s.getLogger(\"geoscene.layers.graphics.sources.support.uploadAssets\").warnOnce(`Service ${o.url} does not support the REST Uploads API.`)}if(!p){const e=await n(u);if(r(i),!e.isBase64)throw new t(`${o.type}-layer:uploadAssets-failure`,\"Expected gltf data in base64 format after conversion.\",new Error);p={assetType:l,assetData:e.data}}if(!p)throw new t(`${o.type}-layer:uploadAssets-failure`,\"Unable to prepare uploadAsset request options.\",new Error);return{item:p,assetName:c}}async function R(s,a,o){const n=await e(i(a.parsedUrl.path,\"uploadAssets\"),{timeout:0,query:{f:\"json\",assets:JSON.stringify(s)},method:\"post\",responseType:\"json\"});if(r(o),n.data.uploadResults.length!==s.length)throw new t(`${a.type}-layer:uploadAssets-failure`,`Bad response. Uploaded ${s.length} items and received ${n.data.uploadResults.length} results.`,new Error);return n.data}function L(e,s,r){const{success:a}=s;if(!a){const{error:a}=s;throw new t(`${r.type}-layer:upload-failure`,`Failed to upload mesh file ${e.assetName}. Error code: ${a.code}. Error message: ${a.messages}`,new Error)}const{assetHash:o}=s,{assetName:n,item:{assetType:i}}=e,{infoFor3D:{supportedFormats:u}}=r,l=y(i,u);if(!l)throw new t(`${r.type}-layer:upload-failure`,`The service allowed us to upload an asset of FormatID ${i}, but it does not list it in its supported formats.`,new Error);return new p(n,l,[new f(`${r.parsedUrl.path}/assets/${o}`,o)])}async function q(s,r,a){const o=s.map((({assetName:e,parts:t})=>({assetName:e,assetHash:t[0].partHash}))),n=r.capabilities?.operations.supportsAsyncConvert3D,u={query:{f:\"json\",assets:JSON.stringify(o),transportType:\"esriTransportTypeUrl\",targetFormat:a,async:n},responseType:\"json\",timeout:0},l=i(r.parsedUrl.path,\"convert3D\"),c=(n?await C(l,u):await e(l,u)).data,{infoFor3D:{supportedFormats:d}}=r;return c.assets.map((e=>{const s=w(e.contentType,d);if(!s)throw new t(`${r.type}-layer:upload-failure`,`The service allowed us to upload an asset of FormatID ${s}, but it does not list it in its supported formats.`,new Error);return new p(e.assetName,e.contentType,[new f(e.assetURL,e.assetHash)])}))}async function C(s,r){const a=(await e(s,r)).data.statusUrl;for(;;){const s=(await e(a,{query:{f:\"json\"},responseType:\"json\"})).data;switch(s.status){case\"Completed\":return e(s.resultUrl,{query:{f:\"json\"},responseType:\"json\"});case\"CompletedWithErrors\":throw new t(\"async-convert3D-failed\",\"asynchronous convert3D call failed.\");case\"Failed ImportChanges\":case\"InProgress\":case\"Pending\":case\"ExportAttachments\":case\"ExportChanges\":case\"ExportingData\":case\"ExportingSnapshot\":case\"ImportAttachments\":case\"ProvisioningReplica\":case\"UnRegisteringReplica\":break;default:throw new t(\"async-convert3D-failed\",\"asynchronous convert3D call failed (undefined response status)\")}await o(H)}}function P(e){return!!e.infoFor3D&&!!e.url}function B(e){const{infoFor3D:s}=e,r=w(\"model/gltf-binary\",s.supportedFormats)??h(\"glb\",s.supportedFormats);if(!r)throw new t(`${e.type}-layer:upload-failure`,\"Layer does not support glb.\",new Error);return r}const H=1e3;export{g as uploadAssets};"],"names":["r","a","n","i","async","p","data","name","c","description","l","m","d","f","u","o","h","w","e","query","responseType","t","y","s","j","maxUploadFileSize","g","q","Math","min","size","Error","T","z","itemName","method","success","itemID","E","item","U","D","ceil","M","Array","push","slice","P","reverse","x","A","length","pop","FormData","append","timeout","body","Promise","all","F","I","parts","map","join","layer","ongoingUploads","get","type","b","set","delete","parsedUrl","metadata","externalSources","some","displaySource","source","$","addExternalSources","N","original","B","extent","clone","load","toBinaryGLTF","ignoreLocalTransform","buffer","blob","Blob","assetName","assetType","infoFor3D","supportedFormats","editFormats","v","includes","asset","S","uploadResults","R","L","File","toBlob","url","assetUploadId","getLogger","warnOnce","isBase64","assetData","path","assets","JSON","stringify","error","code","messages","assetHash","partHash","capabilities","operations","supportsAsyncConvert3D","transportType","targetFormat","C","contentType","assetURL","statusUrl","status","resultUrl","H"],"sourceRoot":""}