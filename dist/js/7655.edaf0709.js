"use strict";(self["webpackChunksun_glare_project"]=self["webpackChunksun_glare_project"]||[]).push([[7655],{69843:function(e,t,n){n.d(t,{w:function(){return s}});n(44114);var r=n(69292),i=n(79908),o=n(42079),a=n(10434);class s{constructor(e=9,t){this._compareMinX=h,this._compareMinY=u,this._toBBox=e=>e,this._maxEntries=Math.max(4,e||9),this._minEntries=Math.max(2,Math.ceil(.4*this._maxEntries)),t&&("function"==typeof t?this._toBBox=t:this._initFormat(t)),this.clear()}destroy(){this.clear(),M.prune(),b.prune(),T.prune(),E.prune()}all(e){this._all(this._data,e)}search(e,t){let n=this._data;const r=this._toBBox;if(_(e,n))for(M.clear();n;){for(let i=0,o=n.children.length;i<o;i++){const o=n.children[i],a=n.leaf?r(o):o;_(e,a)&&(n.leaf?t(o):g(e,a)?this._all(o,t):M.push(o))}n=M.pop()}}collides(e){let t=this._data;const n=this._toBBox;if(!_(e,t))return!1;for(M.clear();t;){for(let r=0,i=t.children.length;r<i;r++){const i=t.children[r],o=t.leaf?n(i):i;if(_(e,o)){if(t.leaf||g(e,o))return!0;M.push(i)}}t=M.pop()}return!1}load(e){if(!e.length)return this;if(e.length<this._minEntries){for(let t=0,n=e.length;t<n;t++)this.insert(e[t]);return this}let t=this._build(e.slice(0,e.length),0,e.length-1,0);if(this._data.children.length)if(this._data.height===t.height)this._splitRoot(this._data,t);else{if(this._data.height<t.height){const e=this._data;this._data=t,t=e}this._insert(t,this._data.height-t.height-1,!0)}else this._data=t;return this}insert(e){return e&&this._insert(e,this._data.height-1),this}clear(){return this._data=new k([]),this}remove(e){if(!e)return this;let t,n=this._data,o=null,a=0,s=!1;const l=this._toBBox(e);for(T.clear(),E.clear();n||T.length>0;){if(n||(n=(0,i.jg)(T.pop()),o=T.data[T.length-1],a=E.pop()??0,s=!0),n.leaf&&(t=(0,r.qh)(n.children,e,n.children.length,n.indexHint),-1!==t))return n.children.splice(t,1),T.push(n),this._condense(T),this;s||n.leaf||!g(n,l)?o?(a++,n=o.children[a],s=!1):n=null:(T.push(n),E.push(a),a=0,o=n,n=n.children[0])}return this}toJSON(){return this._data}fromJSON(e){return this._data=e,this}_all(e,t){let n=e;for(b.clear();n;){if(!0===n.leaf)for(const e of n.children)t(e);else b.pushArray(n.children);n=b.pop()??null}}_build(e,t,n,r){const i=n-t+1;let o=this._maxEntries;if(i<=o){const r=new k(e.slice(t,n+1));return l(r,this._toBBox),r}r||(r=Math.ceil(Math.log(i)/Math.log(o)),o=Math.ceil(i/o**(r-1)));const a=new v([]);a.height=r;const s=Math.ceil(i/o),d=s*Math.ceil(Math.sqrt(o));w(e,t,n,d,this._compareMinX);for(let l=t;l<=n;l+=d){const t=Math.min(l+d-1,n);w(e,l,t,s,this._compareMinY);for(let n=l;n<=t;n+=s){const i=Math.min(n+s-1,t);a.children.push(this._build(e,n,i,r-1))}}return l(a,this._toBBox),a}_chooseSubtree(e,t,n,r){for(;r.push(t),!0!==t.leaf&&r.length-1!==n;){let n,r=1/0,i=1/0;for(let o=0,a=t.children.length;o<a;o++){const a=t.children[o],s=c(a),l=f(e,a)-s;l<i?(i=l,r=s<r?s:r,n=a):l===i&&s<r&&(r=s,n=a)}t=n||t.children[0]}return t}_insert(e,t,n){const r=this._toBBox,i=n?e:r(e);T.clear();const o=this._chooseSubtree(i,this._data,t,T);for(o.children.push(e),p(o,i);t>=0&&T.data[t].children.length>this._maxEntries;)this._split(T,t),t--;this._adjustParentBBoxes(i,T,t)}_split(e,t){const n=e.data[t],r=n.children.length,i=this._minEntries;this._chooseSplitAxis(n,i,r);const o=this._chooseSplitIndex(n,i,r);if(!o)return void console.log("  Error: assertion failed at PooledRBush._split: no valid split index");const a=n.children.splice(o,n.children.length-o),s=n.leaf?new k(a):new v(a);s.height=n.height,l(n,this._toBBox),l(s,this._toBBox),t?e.data[t-1].children.push(s):this._splitRoot(n,s)}_splitRoot(e,t){this._data=new v([e,t]),this._data.height=e.height+1,l(this._data,this._toBBox)}_chooseSplitIndex(e,t,n){let r,i,o;r=i=1/0;for(let a=t;a<=n-t;a++){const t=d(e,0,a,this._toBBox),s=d(e,a,n,this._toBBox),l=m(t,s),p=c(t)+c(s);l<r?(r=l,o=a,i=p<i?p:i):l===r&&p<i&&(i=p,o=a)}return o}_chooseSplitAxis(e,t,n){const r=e.leaf?this._compareMinX:h,i=e.leaf?this._compareMinY:u;this._allDistMargin(e,t,n,r)<this._allDistMargin(e,t,n,i)&&e.children.sort(r)}_allDistMargin(e,t,n,r){e.children.sort(r);const i=this._toBBox,o=d(e,0,t,i),a=d(e,n-t,n,i);let s=y(o)+y(a);for(let l=t;l<n-t;l++){const t=e.children[l];p(o,e.leaf?i(t):t),s+=y(o)}for(let l=n-t-1;l>=t;l--){const t=e.children[l];p(a,e.leaf?i(t):t),s+=y(a)}return s}_adjustParentBBoxes(e,t,n){for(let r=n;r>=0;r--)p(t.data[r],e)}_condense(e){for(let t=e.length-1;t>=0;t--){const n=e.data[t];if(0===n.children.length)if(t>0){const i=e.data[t-1],o=i.children;o.splice((0,r.qh)(o,n,o.length,i.indexHint),1)}else this.clear();else l(n,this._toBBox)}}_initFormat(e){const t=["return a"," - b",";"];this._compareMinX=new Function("a","b",t.join(e[0])),this._compareMinY=new Function("a","b",t.join(e[1])),this._toBBox=new Function("a","return {minX: a"+e[0]+", minY: a"+e[1]+", maxX: a"+e[2]+", maxY: a"+e[3]+"};")}}function l(e,t){d(e,0,e.children.length,t,e)}function d(e,t,n,r,i){i||(i=new k([])),i.minX=1/0,i.minY=1/0,i.maxX=-1/0,i.maxY=-1/0;for(let o,a=t;a<n;a++)o=e.children[a],p(i,e.leaf?r(o):o);return i}function p(e,t){e.minX=Math.min(e.minX,t.minX),e.minY=Math.min(e.minY,t.minY),e.maxX=Math.max(e.maxX,t.maxX),e.maxY=Math.max(e.maxY,t.maxY)}function h(e,t){return e.minX-t.minX}function u(e,t){return e.minY-t.minY}function c(e){return(e.maxX-e.minX)*(e.maxY-e.minY)}function y(e){return e.maxX-e.minX+(e.maxY-e.minY)}function f(e,t){return(Math.max(t.maxX,e.maxX)-Math.min(t.minX,e.minX))*(Math.max(t.maxY,e.maxY)-Math.min(t.minY,e.minY))}function m(e,t){const n=Math.max(e.minX,t.minX),r=Math.max(e.minY,t.minY),i=Math.min(e.maxX,t.maxX),o=Math.min(e.maxY,t.maxY);return Math.max(0,i-n)*Math.max(0,o-r)}function g(e,t){return e.minX<=t.minX&&e.minY<=t.minY&&t.maxX<=e.maxX&&t.maxY<=e.maxY}function _(e,t){return t.minX<=e.maxX&&t.minY<=e.maxY&&t.maxX>=e.minX&&t.maxY>=e.minY}function w(e,t,n,r,o){const s=[t,n];for(;s.length;){const t=(0,i.jg)(s.pop()),n=(0,i.jg)(s.pop());if(t-n<=r)continue;const l=n+Math.ceil((t-n)/r/2)*r;(0,a.q)(e,l,n,t,o),s.push(n,l,l,t)}}const M=new o.A,b=new o.A,T=new o.A,E=new o.A({deallocator:void 0});class I{constructor(){this.minX=1/0,this.minY=1/0,this.maxX=-1/0,this.maxY=-1/0}}class x extends I{constructor(){super(...arguments),this.height=1,this.indexHint=new r.vW}}class k extends x{constructor(e){super(),this.children=e,this.leaf=!0}}class v extends x{constructor(e){super(),this.children=e,this.leaf=!1}}},83800:function(e,t,n){n.d(t,{Hq:function(){return h},PF:function(){return c},Qj:function(){return y},x5:function(){return u}});n(16573),n(78100),n(77936),n(37467),n(44732),n(79577);const r=new Float64Array(2),i=new Float64Array(2),o="0123456789bcdefghjkmnpqrstuvwxyz";function a(e){return o[e]}function s(e){return(e[0]+e[1])/2}function l(e,t,n){return e[0]=t,e[1]=n,e}function d(e,t){const n=s(e),r=t,i=!t;e[0]=i*e[0]+r*n,e[1]=i*n+r*e[1]}function p(e,t){const n=t>s(e);return d(e,n),n}function h(e,t){let n=-90,r=90,i=-180,o=180;for(let a=0;a<t;a++){const t=Math.ceil((a+1)/2),s=Math.floor((a+1)/2),l=1-a%2,d=30-(3*t+2*s),p=30-(2*t+3*s),h=3*l+2*(1-l),u=2*l+3*(1-l),c=3*l+7*(1-l)<<p,y=(7*l+3*(1-l)<<d&e.geohashX)>>d,f=(c&e.geohashY)>>p;for(let e=h-1;e>=0;e--){const t=(i+o)/2,n=y&1<<e?1:0;i=(1-n)*i+n*t,o=(1-n)*t+n*o}for(let e=u-1;e>=0;e--){const t=(n+r)/2,i=f&1<<e?1:0;n=(1-i)*n+i*t,r=(1-i)*t+i*r}}return[i,n,o,r]}function u(e,t,n,r){r%2&&(r+=1);let i=0,o=0,a=-90,s=90,l=-180,d=180;for(let p=0;p<r/2;p++){for(let e=0;e<5;e++){const t=(l+d)/2,r=n>t?1:0;i|=r<<29-(e+5*p),l=(1-r)*l+r*t,d=(1-r)*t+r*d}for(let e=0;e<5;e++){const n=(a+s)/2,r=t>n?1:0;o|=r<<29-(e+5*p),a=(1-r)*a+r*n,s=(1-r)*n+r*s}}e.geohashX=i,e.geohashY=o}function c(e,t,n,r,i){i%2&&(i+=1);let o=0,a=0,s=-90,l=90,d=-180,p=180;for(let h=0;h<i/2;h++){for(let e=0;e<5;e++){const t=(d+p)/2,n=r>t?1:0;o|=n<<29-(e+5*h),d=(1-n)*d+n*t,p=(1-n)*t+n*p}for(let e=0;e<5;e++){const t=(s+l)/2,r=n>t?1:0;a|=r<<29-(e+5*h),s=(1-r)*s+r*t,l=(1-r)*t+r*l}}e[2*t]=o,e[2*t+1]=a}function y(e,t,n){let o="";const s=l(r,-90,90),d=l(i,-180,180);for(let r=0;r<n;r++){let n=0;r%2?(n|=p(s,e)<<4,n|=p(d,t)<<3,n|=p(s,e)<<2,n|=p(d,t)<<1,n|=p(s,e)|0):(n|=p(d,t)<<4,n|=p(s,e)<<3,n|=p(d,t)<<2,n|=p(s,e)<<1,n|=p(d,t)|0),o+=a(n)}return o}},87655:function(e,t,n){n.r(t),n.d(t,{default:function(){return Sn}});n(44114),n(16573),n(78100),n(77936),n(17642),n(58004),n(33853),n(45876),n(32475),n(15024),n(31698),n(37467),n(44732),n(79577);var r=n(71457),i=(n(2516),n(41879)),o=n(47966),a=n(15114),s=n(71120),l=n(76543),d=(n(37679),n(69292),n(51020)),p=n(29916),h=n(83800),u=n(71680),c=n(41312),y=n(47086),f=n(3734),m=n(2256),g=n(9737),_=n(39582),w=n(72465),M=n(32066);const b="ESRI__DESTINATION_ID",T="ESRI__ORIGIN_ID";class E{constructor(){this._featureLookup=new Map}static getInstance(){return E.instance||(E.instance=new E),E.instance}static resetInstance(){E.instance&&(E.instance=null)}deleteFromStore(e){e.forEach((e=>{this._featureLookup.delete(e)}))}readFromStoreByList(e){const t=[];return e.forEach((e=>{const n=this.readFromStoreById(e);n&&t.push(n)})),t}readFromStoreById(e){return this._featureLookup.get(e)??null}writeToStore(e,t,n){const r=[];return e.forEach((e=>{if(!e||!e.id)return;e.properties||(e.properties=[]);let i,o=null;if(n&&(o=e.properties[n]?(0,c.Ux)(e.properties[n]):null),"originId"in e&&"destinationId"in e&&(e.properties[T]=e.originId,e.properties[b]=e.destinationId),e.properties[t]=e.id,e.id&&this._featureLookup.has(e.id)&&this._featureLookup.get(e.id).attributes){const n=this._featureLookup.get(e.id);i=new M.Om(o?JSON.parse(JSON.stringify(o)):n?.geometry?JSON.parse(JSON.stringify(n.geometry)):null,JSON.parse(JSON.stringify(Object.assign(n.attributes,e.properties))),null,e.properties[t])}else i=new M.Om(o?JSON.parse(JSON.stringify(o)):null,e.properties,null,e.properties[t]);this._featureLookup.set(e.id,i),r.push(i)})),r}}var I=n(31745),x=n(86039);let k=class extends f.A{constructor(e){super(e),this.resultRows=[]}};(0,r._)([(0,l.MZ)()],k.prototype,"resultRows",void 0),k=(0,r._)([(0,p.$)("geoscene.rest.knowledgeGraph.GraphQueryResult")],k);const v=k;let C=class extends f.A{constructor(e){super(e),this.resultRowsStream=new ReadableStream}};(0,r._)([(0,l.MZ)()],C.prototype,"resultRowsStream",void 0),C=(0,r._)([(0,p.$)("geoscene.rest.knowledgeGraph.GraphQueryResult")],C);const L=C;var A=n(28920),D=n(12790);let G=class extends A.oY{constructor(e){super(e),this.name=null,this.unique=null,this.ascending=null,this.description=null,this.fieldNames=null}};(0,r._)([(0,l.MZ)({type:String,json:{write:!0}})],G.prototype,"name",void 0),(0,r._)([(0,l.MZ)({type:Boolean,json:{write:!0}})],G.prototype,"unique",void 0),(0,r._)([(0,l.MZ)({type:Boolean,json:{write:!0}})],G.prototype,"ascending",void 0),(0,r._)([(0,l.MZ)({type:String,json:{write:!0}})],G.prototype,"description",void 0),(0,r._)([(0,l.MZ)({type:[String],json:{write:!0}})],G.prototype,"fieldNames",void 0),G=(0,r._)([(0,p.$)("geoscene.rest.knowledgeGraph.FieldIndex")],G);const S=G;let R=class extends A.oY{constructor(e){super(e),this.name=null,this.alias=null,this.fieldType=null,this.geometryType=null,this.hasM=null,this.hasZ=null,this.nullable=null,this.editable=null,this.required=null,this.defaultVisibility=null,this.systemMaintained=null,this.role=null,this.defaultValue=null}};(0,r._)([(0,l.MZ)({type:String,json:{write:!0}})],R.prototype,"name",void 0),(0,r._)([(0,l.MZ)({type:String,json:{write:!0}})],R.prototype,"alias",void 0),(0,r._)([(0,l.MZ)({type:String,json:{write:!0}})],R.prototype,"fieldType",void 0),(0,r._)([(0,l.MZ)({type:String,json:{write:!0}})],R.prototype,"geometryType",void 0),(0,r._)([(0,l.MZ)({type:Boolean,json:{write:!0}})],R.prototype,"hasM",void 0),(0,r._)([(0,l.MZ)({type:Boolean,json:{write:!0}})],R.prototype,"hasZ",void 0),(0,r._)([(0,l.MZ)({type:Boolean,json:{write:!0}})],R.prototype,"nullable",void 0),(0,r._)([(0,l.MZ)({type:Boolean,json:{write:!0}})],R.prototype,"editable",void 0),(0,r._)([(0,l.MZ)({type:Boolean,json:{write:!0}})],R.prototype,"required",void 0),(0,r._)([(0,l.MZ)({type:Boolean,json:{write:!0}})],R.prototype,"defaultVisibility",void 0),(0,r._)([(0,l.MZ)({type:Boolean,json:{write:!0}})],R.prototype,"systemMaintained",void 0),(0,r._)([(0,l.MZ)()],R.prototype,"role",void 0),(0,r._)([(0,l.MZ)({type:Object,json:{type:String,write:{writer:(e,t)=>{t.defaultValue=null!=e?e.toString():null}}}})],R.prototype,"defaultValue",void 0),R=(0,r._)([(0,p.$)("geoscene.rest.knowledgeGraph.GraphProperty")],R);const N=R;let j=class extends A.oY{constructor(e){super(e),this.name=null,this.alias=null,this.role=null,this.strict=null,this.properties=null,this.fieldIndexes=null}};(0,r._)([(0,l.MZ)({type:String,json:{write:!0}})],j.prototype,"name",void 0),(0,r._)([(0,l.MZ)({type:String,json:{write:!0}})],j.prototype,"alias",void 0),(0,r._)([(0,l.MZ)({type:String,json:{write:!0}})],j.prototype,"role",void 0),(0,r._)([(0,l.MZ)({type:Boolean,json:{write:!0}})],j.prototype,"strict",void 0),(0,r._)([(0,l.MZ)({type:[N],json:{write:!0}})],j.prototype,"properties",void 0),(0,r._)([(0,l.MZ)({type:[S],json:{write:!0}})],j.prototype,"fieldIndexes",void 0),j=(0,r._)([(0,p.$)("geoscene.rest.knowledgeGraph.GraphObjectType")],j);const F=j;let P=class extends F{constructor(e){super(e)}};P=(0,r._)([(0,p.$)("geoscene.rest.knowledgeGraph.EntityType")],P);const O=P;let Z=class extends F{constructor(e){super(e),this.endPoints=[]}};(0,r._)([(0,l.MZ)()],Z.prototype,"endPoints",void 0),Z=(0,r._)([(0,p.$)("geoscene.rest.knowledgeGraph.RelationshipType")],Z);const B=Z;let Y=class extends A.oY{constructor(e){super(e),this.timestamp=null,this.spatialReference=null,this.strict=null,this.objectIdField=null,this.globalIdField=null,this.arcgisManaged=null,this.identifierInfo=null,this.searchIndexes=null,this.entityTypes=null,this.relationshipTypes=null}};(0,r._)([(0,l.MZ)({type:Date,json:{type:Number,write:{writer:(e,t)=>{t.timestamp=e?.getTime()}}}})],Y.prototype,"timestamp",void 0),(0,r._)([(0,l.MZ)({type:D.A,json:{write:!0}})],Y.prototype,"spatialReference",void 0),(0,r._)([(0,l.MZ)({type:Boolean,json:{write:!0}})],Y.prototype,"strict",void 0),(0,r._)([(0,l.MZ)({type:String,json:{write:!0}})],Y.prototype,"objectIdField",void 0),(0,r._)([(0,l.MZ)({type:String,json:{write:!0}})],Y.prototype,"globalIdField",void 0),(0,r._)([(0,l.MZ)()],Y.prototype,"arcgisManaged",void 0),(0,r._)([(0,l.MZ)()],Y.prototype,"identifierInfo",void 0),(0,r._)([(0,l.MZ)()],Y.prototype,"searchIndexes",void 0),(0,r._)([(0,l.MZ)({type:[O],json:{write:!0}})],Y.prototype,"entityTypes",void 0),(0,r._)([(0,l.MZ)({type:[B],json:{write:!0}})],Y.prototype,"relationshipTypes",void 0),Y=(0,r._)([(0,p.$)("geoscene.rest.knowledgeGraph.DataModel")],Y);const Q=Y;let z=class extends A.oY{constructor(e){super(e),this.capabilities=[],this.supportsSearch=!1,this.supportedQueryFormats=[],this.allowGeometryUpdates=!1,this.searchMaxRecordCount=null,this.serviceCapabilities=null,this.maxRecordCount=null,this.description="",this.copyrightText="",this.units="",this.spatialReference=null,this.currentVersion=null,this.dateFieldsTimeReference=null,this.serviceItemId="",this.supportsDocuments=!1,this.dataEditingNotSupported=!1,this.schemaEditingNotSupported=!1}};(0,r._)([(0,l.MZ)({type:[String],json:{write:!0}})],z.prototype,"capabilities",void 0),(0,r._)([(0,l.MZ)({type:Boolean,json:{write:!0}})],z.prototype,"supportsSearch",void 0),(0,r._)([(0,l.MZ)({type:[String],json:{write:!0}})],z.prototype,"supportedQueryFormats",void 0),(0,r._)([(0,l.MZ)({type:Boolean,json:{write:!0}})],z.prototype,"allowGeometryUpdates",void 0),(0,r._)([(0,l.MZ)({type:Number,json:{write:!0}})],z.prototype,"searchMaxRecordCount",void 0),(0,r._)([(0,l.MZ)({type:Object,json:{write:!0}})],z.prototype,"serviceCapabilities",void 0),(0,r._)([(0,l.MZ)({type:Number,json:{write:!0}})],z.prototype,"maxRecordCount",void 0),(0,r._)([(0,l.MZ)({type:String,json:{write:!0}})],z.prototype,"description",void 0),(0,r._)([(0,l.MZ)({type:String,json:{write:!0}})],z.prototype,"copyrightText",void 0),(0,r._)([(0,l.MZ)({type:String,json:{write:!0}})],z.prototype,"units",void 0),(0,r._)([(0,l.MZ)({type:Object,json:{write:!0}})],z.prototype,"spatialReference",void 0),(0,r._)([(0,l.MZ)({type:Number,json:{write:!0}})],z.prototype,"currentVersion",void 0),(0,r._)([(0,l.MZ)({type:Object,json:{write:!0}})],z.prototype,"dateFieldsTimeReference",void 0),(0,r._)([(0,l.MZ)({type:String,json:{write:!0}})],z.prototype,"serviceItemId",void 0),(0,r._)([(0,l.MZ)({type:Boolean,json:{write:!0}})],z.prototype,"supportsDocuments",void 0),(0,r._)([(0,l.MZ)({type:Boolean,json:{write:!0}})],z.prototype,"dataEditingNotSupported",void 0),(0,r._)([(0,l.MZ)({type:Boolean,json:{write:!0}})],z.prototype,"schemaEditingNotSupported",void 0),z=(0,r._)([(0,p.$)("geoscene.rest.knowledgeGraph.ServiceDefinition")],z);const U=z;let $=class extends A.oY{constructor(e){super(e),this.dataModel=null,this.serviceDefinition=null}};(0,r._)([(0,l.MZ)({type:String,json:{write:!0}})],$.prototype,"url",void 0),(0,r._)([(0,l.MZ)({type:Q,json:{write:!0}})],$.prototype,"dataModel",void 0),(0,r._)([(0,l.MZ)({type:U,json:{write:!0}})],$.prototype,"serviceDefinition",void 0),$=(0,r._)([(0,p.$)("geoscene.rest.knowledgeGraph.KnowledgeGraph")],$);const q=$;var H=n(8281);const X="geoscene/rest/knowledgeGraph/wasmInterface/";let J,W=null;async function V(){const e=W??J;if(e)return e;const t=(0,d.A)("wasm-simd");return J=K(t),J}async function K(e){if(e){const{default:e}=await n.e(7787).then(n.bind(n,47787)).then((e=>e.a));return e({locateFile:e=>(0,H.s)(X+e)})}const{default:t}=await n.e(5449).then(n.bind(n,95449)).then((e=>e.a));return t({locateFile:e=>(0,H.s)(X+e)})}var ee=n(42346),te=n(74036),ne=n(68491),re=n(88679);function ie(e,t){const n=new t.ArrayValue;return n.deleteLater(),e.forEach((e=>{n.add_value(de(e,t))})),n}function oe(e,t){const n=new t.ObjectValue;n.deleteLater();for(const[r,i]of Object.entries(e))n.set_key_value(r,de(i,t));return n}function ae(e,t){if(e instanceof ee.A)return he(e,t);if(e instanceof te.A)return ue(e,t);if(e instanceof ne.A||e instanceof g.A)return pe(e,t);throw new o.A("knowledge-graph:unsupported-geometry","Only Point, Multipoint, Polyline, and Polygon geometry are supported by ArcGIS Knowledge",{geometry:e})}function se(e,t){t.input_quantization_parameters={xy_resolution:e.xyResolution,x_false_origin:e.xFalseOrigin,y_false_origin:e.yFalseOrigin,z_resolution:e.zResolution,z_false_origin:e.zFalseOrigin,m_resolution:e.mResolution,m_false_origin:e.mFalseOrigin}}function le(e,t,n){if(!e.extent)throw new o.A("knowledge-graph:illegal-output-quantization","The Output quantization provided to the encoder had an illegal value as part of its extent",e.extent);if(!e.quantizeMode)throw new o.A("knowledge-graph:illegal-output-quantization","The Output quantization contained an illegal mode setting",e.quantizeMode);if(!e.tolerance)throw new o.A("knowledge-graph:illegal-output-quantization","The Output quantization contained an illegal tolerance setting",e.quantizeMode);t.output_quantization_parameters={extent:{xmax:e.extent.xmax,ymax:e.extent.ymax,xmin:e.extent.xmin,ymin:e.extent.ymin},quantize_mode:n.esriQuantizeMode[e.quantizeMode],tolerance:e.tolerance}}function de(e,t){if(null==e)return"";if("object"!=typeof e)return e;if(e instanceof Date)return e;if(e instanceof re.A)return ae(e,t);if(Array.isArray(e)){const n=new t.ArrayValue;return n.deleteLater(),e.forEach((e=>{n.add_value(de(e,t))})),n}return oe(e,t)}function pe(e,t){const n=new t.GeometryValue;n.deleteLater(),n.has_z=e.hasZ,n.has_m=e.hasM;const r=[],i=[];let o=[];e instanceof ne.A?(n.geometry_type=t.esriGeometryType.esriGeometryPolyline,o=e.paths):e instanceof g.A&&(n.geometry_type=t.esriGeometryType.esriGeometryPolygon,o=e.rings);let a=0,s=0;return o.forEach((e=>{let t=0;e.forEach((e=>{t++,e.forEach((e=>{r[s]=e,s++}))})),i[a]=t,a++})),n.coords=new Float64Array(r),n.lengths=new Uint32Array(i),n}function he(e,t){const n=new t.GeometryValue;n.deleteLater(),n.geometry_type=n.geometry_type=t.esriGeometryType.esriGeometryMultipoint,n.has_z=e.hasZ,n.has_m=e.hasM;const r=[],i=[];i[0]=e.points.length;let o=0;return e.points.forEach((e=>{e.forEach((e=>{r[o]=e,o++}))})),n.coords=new Float64Array(r),n.lengths=new Uint32Array(i),n}function ue(e,t){const n=new t.GeometryValue;n.deleteLater(),n.geometry_type=t.esriGeometryType.esriGeometryPoint,n.has_z=e.hasZ,n.has_m=e.hasM;const r=[],i=[];i[0]=1,r[0]=e.x,r[1]=e.y;let o=2;return e.hasZ&&(r[o]=e.z,o++),e.hasM&&(r[o]=e.m,o++),n.coords=new Float64Array(r),n.lengths=new Uint32Array(i),n}let ce=class extends A.oY{constructor(e){super(e),this.properties=null}};(0,r._)([(0,l.MZ)({json:{write:!0}})],ce.prototype,"properties",void 0),ce=(0,r._)([(0,p.$)("geoscene.rest.knowledgeGraph.GraphObject")],ce);const ye=ce;let fe=class extends ye{constructor(e){super(e),this.typeName=null,this.id=null}};(0,r._)([(0,l.MZ)({type:String,json:{write:!0}})],fe.prototype,"typeName",void 0),(0,r._)([(0,l.MZ)({type:String,json:{write:!0}})],fe.prototype,"id",void 0),fe=(0,r._)([(0,p.$)("geoscene.rest.knowledgeGraph.GraphNamedObject")],fe);const me=fe;let ge=class extends me{constructor(e){super(e),this.layoutGeometry=null}};(0,r._)([(0,l.MZ)({type:te.A,json:{write:!0}})],ge.prototype,"layoutGeometry",void 0),ge=(0,r._)([(0,p.$)("geoscene.rest.knowledgeGraph.Entity")],ge);const _e=ge;let we=class extends me{constructor(e){super(e),this.originId=null,this.destinationId=null,this.layoutGeometry=null}};(0,r._)([(0,l.MZ)({type:String,json:{write:!0}})],we.prototype,"originId",void 0),(0,r._)([(0,l.MZ)({type:String,json:{write:!0}})],we.prototype,"destinationId",void 0),(0,r._)([(0,l.MZ)({type:ne.A,json:{write:!0}})],we.prototype,"layoutGeometry",void 0),we=(0,r._)([(0,p.$)("geoscene.rest.Relationship.Relationship")],we);const Me=we;function be(e,t){if(!e.typeName)throw new o.A("knowledge-graph:no-type-name","You must indicate the entity/relationship named object type to apply edits");if(e instanceof _e){const n=new t.EntityValue;n.deleteLater(),n.type_name=e.typeName;for(const[r,i]of Object.entries(e.properties))n.set_key_value(r,Ee(i,t));return e.id&&n.set_id(e.id),n}if(e instanceof Me){const n=new t.RelationshipValue;n.deleteLater(),n.type_name=e.typeName;for(const[r,i]of Object.entries(e.properties))n.set_key_value(r,Ee(i,t));return e.id&&n.set_id(e.id),e.originId&&e.destinationId&&n.set_related_entity_ids(e.originId,e.destinationId),n}throw new o.A("knowledge-graph:applyEdits-encoding-failure","Could not determine the type of a named graph object passed to the encoder")}function Te(e){return{xy_resolution:e.xyResolution,x_false_origin:e.xFalseOrigin,y_false_origin:e.yFalseOrigin,z_resolution:e.zResolution,z_false_origin:e.zFalseOrigin,m_resolution:e.mResolution,m_false_origin:e.mFalseOrigin}}function Ee(e,t){return null==e?"":"object"!=typeof e||e instanceof Date?e:e instanceof re.A?ae(e,t):""}let Ie=class extends f.A{constructor(e){super(e),this.name=null,this.supportedCategory=null,this.analyzers=[],this.searchProperties=new Map}};(0,r._)([(0,l.MZ)()],Ie.prototype,"name",void 0),(0,r._)([(0,l.MZ)()],Ie.prototype,"supportedCategory",void 0),(0,r._)([(0,l.MZ)()],Ie.prototype,"analyzers",void 0),(0,r._)([(0,l.MZ)()],Ie.prototype,"searchProperties",void 0),Ie=(0,r._)([(0,p.$)("geoscene.rest.knowledgeGraph.SearchIndex")],Ie);const xe=Ie;var ke,ve,Ce,Le,Ae,De,Ge;function Se(e){return e.deleteLater(),new Q({timestamp:e.timestamp,spatialReference:new D.A(e.spatial_reference),strict:e.strict,objectIdField:e.objectid_property,globalIdField:e.globalid_property,arcgisManaged:e.arcgis_managed,identifierInfo:{identifierMappingInfo:{identifierInfoType:Ge[e.identifier_info?.identifier_mapping_info?.identifier_info_type?.value],databaseNativeIdentifier:e.identifier_info?.identifier_mapping_info?.database_native_identifier,uniformPropertyIdentifier:{identifierPropertyName:e.identifier_info?.identifier_mapping_info?.uniform_property_identifier?.identifier_property_name}},identifierGenerationInfo:{uuidMethodHint:Le[e.identifier_info?.identifier_generation_info?.uuid_method_hint?.value]}},searchIndexes:ze(e.search_indexes),entityTypes:Oe(e.entity_types),relationshipTypes:Qe(e.relationship_types)})}function Re(e){return e.deleteLater(),new O(je(e))}function Ne(e){return e.deleteLater(),new S({name:e.name,unique:e.unique,ascending:e.ascending,description:e.description,fieldNames:Ze(e.fields)})}function je(e){return{name:e.name,alias:e.alias,role:ke[e.role.value]?ke[e.role.value]:null,strict:e.strict,properties:Be(e.properties),fieldIndexes:Ye(e.field_indexes)}}function Fe(e){return e.deleteLater(),new N({alias:e.alias,name:e.name,fieldType:ve[e.field_type.value]?ve[e.field_type.value]:null,geometryType:Ce[e.geometry_type.value]?Ce[e.geometry_type.value]:null,hasM:e.has_m,hasZ:e.has_z,nullable:e.nullable,editable:e.editable,required:e.required,defaultVisibility:e.default_visibility,systemMaintained:e.system_maintained,role:De[e.role.value],defaultValue:e.default_value})}function Pe(e){e.deleteLater();const t=je(e),n=[];for(let r=0;r<e.end_points.size();r++){const t=e.end_points.get(r);n.push({originEntityType:t.origin_entity_type,destinationEntityType:t.dest_entity_type})}return new B(Object.assign({endPoints:n},t))}function Oe(e){const t=[];for(let n=0;n<e.size();n++)t.push(Re(e.get(n)));return t}function Ze(e){const t=[];for(let n=0;n<e.size();n++)t.push(e.get(n));return t}function Be(e){const t=[];for(let n=0;n<e.size();n++)t.push(Fe(e.get(n)));return t}function Ye(e){const t=[];for(let n=0;n<e.size();n++)t.push(Ne(e.get(n)));return t}function Qe(e){const t=[];for(let n=0;n<e.size();n++)t.push(Pe(e.get(n)));return t}function ze(e){const t=[];for(let n=0;n<e.size();n++){const n=new xe,r=e.get(0);n.name=r.name,n.supportedCategory=Ae[r.supported_category.value];const i=r.analyzers.size();for(let e=0;e<i;e++)n.analyzers.push({name:r.analyzers.get(e).name});for(let e=0;e<r.search_properties.keys().size();e++){const t=r.search_properties.keys().get(e),i=r.search_properties.get(t),o=[];for(let e=0;e<i.property_names.size();e++)o.push(i.property_names.get(e));n.searchProperties.set(t,{propertyNames:o})}t.push(n)}return t}!function(e){e[e.Regular=0]="Regular",e[e.Provenance=1]="Provenance",e[e.Document=2]="Document"}(ke||(ke={})),function(e){e[e.esriFieldTypeSmallInteger=0]="esriFieldTypeSmallInteger",e[e.esriFieldTypeInteger=1]="esriFieldTypeInteger",e[e.esriFieldTypeSingle=2]="esriFieldTypeSingle",e[e.esriFieldTypeDouble=3]="esriFieldTypeDouble",e[e.esriFieldTypeString=4]="esriFieldTypeString",e[e.esriFieldTypeDate=5]="esriFieldTypeDate",e[e.esriFieldTypeOID=6]="esriFieldTypeOID",e[e.esriFieldTypeGeometry=7]="esriFieldTypeGeometry",e[e.esriFieldTypeBlob=8]="esriFieldTypeBlob",e[e.esriFieldTypeRaster=9]="esriFieldTypeRaster",e[e.esriFieldTypeGUID=10]="esriFieldTypeGUID",e[e.esriFieldTypeGlobalID=11]="esriFieldTypeGlobalID",e[e.esriFieldTypeXML=12]="esriFieldTypeXML",e[e.esriFieldTypeBigInteger=13]="esriFieldTypeBigInteger"}(ve||(ve={})),function(e){e[e.esriGeometryNull=0]="esriGeometryNull",e[e.esriGeometryPoint=1]="esriGeometryPoint",e[e.esriGeometryMultipoint=2]="esriGeometryMultipoint",e[e.esriGeometryPolyline=3]="esriGeometryPolyline",e[e.esriGeometryPolygon=4]="esriGeometryPolygon",e[e.esriGeometryEnvelope=5]="esriGeometryEnvelope",e[e.esriGeometryAny=6]="esriGeometryAny",e[e.esriGeometryMultiPatch=7]="esriGeometryMultiPatch"}(Ce||(Ce={})),function(e){e[e.esriMethodHintUNSPECIFIED=0]="esriMethodHintUNSPECIFIED",e[e.esriUUIDESRI=1]="esriUUIDESRI",e[e.esriUUIDRFC4122=2]="esriUUIDRFC4122"}(Le||(Le={})),function(e){e[e.esriTypeUNSPECIFIED=0]="esriTypeUNSPECIFIED",e[e.esriTypeEntity=1]="esriTypeEntity",e[e.esriTypeRelationship=2]="esriTypeRelationship",e[e.esriTypeBoth=4]="esriTypeBoth"}(Ae||(Ae={})),function(e){e[e.esriGraphPropertyUNSPECIFIED=0]="esriGraphPropertyUNSPECIFIED",e[e.esriGraphPropertyRegular=1]="esriGraphPropertyRegular",e[e.esriGraphPropertyDocumentName=2]="esriGraphPropertyDocumentName",e[e.esriGraphPropertyDocumentTitle=3]="esriGraphPropertyDocumentTitle",e[e.esriGraphPropertyDocumentUrl=4]="esriGraphPropertyDocumentUrl",e[e.esriGraphPropertyDocumentText=5]="esriGraphPropertyDocumentText",e[e.esriGraphPropertyDocumentKeywords=6]="esriGraphPropertyDocumentKeywords",e[e.esriGraphPropertyDocumentContentType=7]="esriGraphPropertyDocumentContentType",e[e.esriGraphPropertyDocumentMetadata=8]="esriGraphPropertyDocumentMetadata",e[e.esriGraphPropertyDocumentFileExtension=9]="esriGraphPropertyDocumentFileExtension"}(De||(De={})),function(e){e[e.esriIdentifierInfoTypeUNSPECIFIED=0]="esriIdentifierInfoTypeUNSPECIFIED",e[e.esriIdentifierInfoTypeDatabaseNative=1]="esriIdentifierInfoTypeDatabaseNative",e[e.esriIdentifierInfoTypeUniformProperty=2]="esriIdentifierInfoTypeUniformProperty"}(Ge||(Ge={}));let Ue=class extends ye{constructor(e){super(e)}};Ue=(0,r._)([(0,p.$)("geoscene.rest.knowledgeGraph.ObjectValue")],Ue);const $e=Ue;let qe=class extends A.oY{constructor(e){super(e),this.path=null}};(0,r._)([(0,l.MZ)({type:[ye],json:{write:!0}})],qe.prototype,"path",void 0),qe=(0,r._)([(0,p.$)("geoscene.rest.knowledgeGraph.Path")],qe);const He=qe;var Xe,Je,We;function Ve(e){const t={},n=rt(e,t),r=e.lengths,i=e.coords,o=r[0];t.points=[];let a=0;for(let s=0;s<o;s++){const e=[];for(let t=0;t<n;t++)e[t]=i[a],a++;t.points.push(e)}return new ee.A(t)}function Ke(e){const t={};let n=2;rt(e,t);const r=e.coords;return t.x=r[0],t.y=r[1],e.has_z&&(t.z=r[n],n++),e.has_m&&(t.m=r[n]),new te.A(t)}function et(e){return new ne.A(nt(e))}function tt(e){return new g.A(nt(e))}function nt(e){const t={},n=rt(e,t),r=e.lengths,i=e.coords;let a="";if(e.geometry_type.value===Xe.ESRI_GEOMETRY_POLYGON)a="rings";else{if(e.geometry_type.value!==Xe.ESRI_GEOMETRY_POLYLINE)throw new o.A("KnowledgeGraph:illegal-geometry-type","Illegal Geometry type for multipath conversion");a="paths"}t[a]=[];let s=0;return r.forEach((e=>{const r=[];for(let t=0;t<e;t++){const e=[];for(let t=0;t<n;t++)e[t]=i[s],s++;r.push(e)}t[a].push(r)})),t}function rt(e,t){let n=2;return e.has_z?(t.hasZ=e.has_z,n++):t.hasZ=!1,e.has_m?(t.hasM=e.has_m,n++):t.hasM=!1,n}!function(e){e[e.ESRI_GEOMETRY_NULL=0]="ESRI_GEOMETRY_NULL",e[e.ESRI_GEOMETRY_POINT=1]="ESRI_GEOMETRY_POINT",e[e.ESRI_GEOMETRY_MULTIPOINT=2]="ESRI_GEOMETRY_MULTIPOINT",e[e.ESRI_GEOMETRY_POLYLINE=3]="ESRI_GEOMETRY_POLYLINE",e[e.ESRI_GEOMETRY_POLYGON=4]="ESRI_GEOMETRY_POLYGON",e[e.ESRI_GEOMETRY_ENVELOPE=5]="ESRI_GEOMETRY_ENVELOPE",e[e.ESRI_GEOMETRY_ANY=6]="ESRI_GEOMETRY_ANY",e[e.ESRI_GEOMETRY_MULTI_PATCH=7]="ESRI_GEOMETRY_MULTI_PATCH"}(Xe||(Xe={})),function(e){e[e.OBJECT=0]="OBJECT",e[e.ENTITY=1]="ENTITY",e[e.RELATIONSHIP=2]="RELATIONSHIP",e[e.PATH=3]="PATH",e[e.ARRAY=4]="ARRAY"}(Je||(Je={})),function(e){e[e.view=0]="view",e[e.edit=1]="edit"}(We||(We={}));const it=a.A.getLogger("geoscene.rest.knowledgeGraph.WasmToQueryResponseObjConstructors"),ot={decodedWasmObjToQueryResponseObj:(e,t)=>{if(null==e)return null;if("object"!=typeof e)return e;if("getDate"in e)return e;if("geometry_type"in e)switch(e.geometry_type.value){case null:return null;case Xe.ESRI_GEOMETRY_POINT:return Ke(e);case Xe.ESRI_GEOMETRY_MULTIPOINT:return Ve(e);case Xe.ESRI_GEOMETRY_POLYLINE:return et(e);case Xe.ESRI_GEOMETRY_POLYGON:return tt(e);case Xe.ESRI_GEOMETRY_ENVELOPE:case Xe.ESRI_GEOMETRY_MULTI_PATCH:return it.warnOnce("Envelope and Multipatch are not supported on knowledge entities, but one of those geometry types was detected. Result interpreted as null"),null;case Xe.ESRI_GEOMETRY_NULL:case Xe.ESRI_GEOMETRY_ANY:default:return it.warnOnce("Unknown or blank geometry type returned - Result interpreted as null"),null}else{if(!("object_value_type"in e))return it.warnOnce("A decoded value came back of a type that is not supported. Result interpreted as null"),null;switch(e.object_value_type.value){case Je.OBJECT:return pt(e,t);case Je.ENTITY:return lt(e,t);case Je.RELATIONSHIP:return ut(e,t);case Je.PATH:return ht(e,t);case Je.ARRAY:return at(e,t);default:return it.warnOnce("Unknown graph object type detected!  Result interpreted as null"),null}}}};function at(e,t){const n=[],r=e.count();for(let i=0;i<r;i++){const r=e.get_value_at(i);n.push(st(r,t))}return n}function st(e,t){return ot.decodedWasmObjToQueryResponseObj(e,t)}function lt(e,t){const n=e.type_name,r=dt(e,t),i=e.get_id();return new _e(Object.assign({typeName:n,id:i},r))}function dt(e,t){const n={},r=e.key_count();for(let i=0;i<r;i++)n[e.get_key_at(i)]=st(e.get_value_at(i),t);return{properties:n}}function pt(e,t){return new $e(dt(e,t))}function ht(e,t){const n=e.entity_count(),r=e.relationship_count(),i=[];for(let o=0;o<n;o++)i.push(lt(e.get_entity_at(o),t)),o<r&&i.push(ut(e.get_relationship_at(o),t));return new He({path:i})}function ut(e,t){const n=e.type_name,r=dt(e,t);return new Me(Object.assign({typeName:n,id:e.get_id(),originId:e.get_origin_entity_id(),destinationId:e.get_destination_entity_id()},r))}let ct=class extends f.A{constructor(e){super(e),this.hasError=null,this.error=null,this.editResults=[]}};(0,r._)([(0,l.MZ)()],ct.prototype,"hasError",void 0),(0,r._)([(0,l.MZ)()],ct.prototype,"error",void 0),(0,r._)([(0,l.MZ)()],ct.prototype,"editResults",void 0),ct=(0,r._)([(0,p.$)("geoscene.rest.knowledgeGraph.GraphApplyEdits")],ct);const yt=ct;function ft(e){const t=new yt;t.hasError=e.has_error(),t.hasError&&(t.error={errorCode:e.error.error_code,errorMessage:e.error.error_message});const n=e.get_edit_results_count();for(let r=0;r<n;r++){const n=e.get_edit_results_at(r),i=e.get_edit_results_type_name_at(r),o=[],a=[],s=[],l=n.get_add_results_count(),d=n.get_update_results_count(),p=n.get_delete_results_count();for(let e=0;e<l;e++){const t=n.get_add_result_at(e);o.push({id:t.id,error:{errorCode:t.error.error_code,errorMessage:t.error.error_message}})}for(let e=0;e<d;e++){const t=n.get_update_result_at(e);a.push({id:t.id,error:{errorCode:t.error.error_code,errorMessage:t.error.error_message}})}for(let e=0;e<p;e++){const t=n.get_delete_result_at(e);s.push({id:t.id,error:{errorCode:t.error.error_code,errorMessage:t.error.error_message}})}t.editResults.push({typeName:i,adds:o,updates:a,deletes:s})}return t}const mt={fetchKnowledgeGraph:async e=>{const t=new q({url:e}),n=[];return n.push(wt(t)),n.push(Mt(t)),await Promise.all(n),t},refreshDataModel:async e=>{e.dataModel=await Gt(e)},refreshServiceDefinition:async e=>{const t=(await(0,x["default"])(e.url,{query:{f:"json"}})).data;return t.capabilities=t?.capabilities?.split(","),t.supportedQueryFormats=t?.supportedQueryFormats?.split(","),e.serviceDefinition=new U(t),e.serviceDefinition},executeQueryStreaming:async(e,t,n)=>{const r=`${e.url}/graph/query`;await Tt(e);const i=await Ct(r,n);i.data.body=await kt(t,e);const a=await bt(i.data.url,i.data);if(e.dataModel)return new L({resultRowsStream:await Dt(a,e.dataModel)});throw new o.A("knowledge-graph:undefined-data-model","The KnowledgeGraph supplied did not have a data model")},executeApplyEdits:async(e,t,n)=>{if(e.serviceDefinition?.dataEditingNotSupported)throw new o.A("knowledge-graph:data-editing-not-supported","The Knowledge Graph Service definition indicated that data editing is not supported");const r=`${e.url}/graph/applyEdits`;await Tt(e);const i=await Ct(r,n);return i.data.body=await xt(t,e),Lt(await bt(i.data.url,i.data))},executeQuery:async(e,t,n)=>{const r=`${e.url}/graph/query`,i=await(0,x["default"])(r,{responseType:"array-buffer",query:{f:"pbf",openCypherQuery:t.openCypherQuery,...n?.query},signal:n?.signal,timeout:n?.timeout}),a=i.getHeader?.("content-type"),s=i.data;if(a?.includes("application/x-protobuf")){const t=new((await V()).GraphQueryDecoder);if(t.deleteLater(),e.dataModel)return new v({resultRows:At(t,s,e.dataModel)});throw new o.A("knowledge-graph:undefined-data-model","The KnowledgeGraph supplied did not have a data model")}throw new o.A("knowledge-graph:unexpected-server-response","server returned an unexpected response",{responseType:a,data:i.data})},executeSearch:async(e,t,n)=>{const r=t.typeCategoryFilter,i=`${e.url}/graph/search`,a=await(0,x["default"])(i,{responseType:"array-buffer",query:{f:"pbf",searchQuery:`"${t.searchQuery}"`,typeCategoryFilter:r,...n?.query},signal:n?.signal,timeout:n?.timeout}),s=a.getHeader?.("content-type"),l=a.data;if(s?.includes("application/x-protobuf")){const t=new((await V()).GraphQueryDecoder);if(t.deleteLater(),e.dataModel)return new v({resultRows:At(t,l,e.dataModel)});throw new o.A("knowledge-graph:undefined-data-model","The KnowledgeGraph supplied did not have a data model")}throw new o.A("knowledge-graph:unexpected-server-response","server returned an unexpected response",{responseType:s,data:a.data})},executeSearchStreaming:async(e,t,n)=>{const r=`${e.url}/graph/search`;await Tt(e);const i=await Ct(r,n);i.data.body=await vt(t);const a=await bt(i.data.url,i.data);if(e.dataModel)return new L({resultRowsStream:await Dt(a,e.dataModel)});throw new o.A("knowledge-graph:undefined-data-model","The KnowledgeGraph supplied did not have a data model")},_fetchWrapper:async(e,t)=>fetch(e,t)};async function gt(e,t,n){return mt.executeQueryStreaming(e,t,n)}async function _t(e){return mt.fetchKnowledgeGraph(e)}async function wt(e){return mt.refreshDataModel(e)}async function Mt(e){return mt.refreshServiceDefinition(e)}async function bt(e,t){return mt._fetchWrapper(e,t)}async function Tt(e){const t=I.id?.findCredential(e.url);t||(e.dataModel?await Gt(e):await wt(e))}function Et(e,t,n){if(0!==e.error_code)throw new o.A(t,n,{errorCode:e.error_code,errorMessage:e.error_message})}function It(e,t,n,r){null==t?n.set_param_key_value(e,""):"object"!=typeof t||t instanceof Date?n.set_param_key_value(e,t):t instanceof re.A?n.set_param_key_value(e,ae(t,r)):t instanceof Array?n.set_param_key_value(e,ie(t,r)):n.set_param_key_value(e,oe(t,r))}async function xt(e,t){if(t.dataModel||await wt(t),!t.dataModel)throw new o.A("knowledge-graph:data-model-undefined","Encoding could not proceed because a data model was not provided and it could not be determined from the service");const n=await V(),r=!!e.options?.cascadeDelete,i=new n.GraphApplyEditsEncoder(n.SpatialReferenceUtil.WGS84(),e.options?.inputQuantizationParameters?Te(e.options?.inputQuantizationParameters):n.InputQuantizationUtil.WGS84_lossless());i.deleteLater(),i.cascade_delete=r;try{let t;e.entityAdds?.forEach((e=>{t=i.add_entity(be(e,n)),Et(t,"knowledge-graph:applyEdits-encoding-failed","Attempting to encode the applyEdits - an entity failed to be added to the encoder")})),e.relationshipAdds?.forEach((e=>{if(!e.originId||!e.destinationId)throw new o.A("knowledge-graph:relationship-origin-destination-missing","When adding a new relationship, you must provide both an origin and destination id on the appropriate class property");t=i.add_relationship(be(e,n)),Et(t,"knowledge-graph:applyEdits-encoding-failed","Attempting to encode the applyEdits - a relationship failed to be added to the encoder")})),e.entityUpdates?.forEach((e=>{if(!e.id)throw new o.A("knowledge-graph:entity-id-missing","When updating an entity or relationship, you must specify the id on the class level property");t=i.update_entity(be(e,n)),Et(t,"knowledge-graph:applyEdits-encoding-failed","Attempting to encode the applyEdits - an entity failed to be added to the encoder")})),e.relationshipUpdates?.forEach((e=>{if(!e.id)throw new o.A("knowledge-graph:relationship-id-missing","When updating an entity or relationship, you must specify the id on the class level property");t=i.update_relationship(be(e,n)),Et(t,"knowledge-graph:applyEdits-encoding-failed","Attempting to encode the applyEdits - a relationship failed to be added to the encoder")})),e.entityDeletes?.forEach((e=>{if(!e.typeName)throw new o.A("knowledge-graph:no-type-name","You must indicate the entity/relationship named object type to apply edits - delete");const t=i.make_delete_helper(e.typeName,!0);t.deleteLater(),e.ids?.forEach((e=>{t.delete_by_id(e)}))})),e.relationshipDeletes?.forEach((e=>{if(!e.typeName)throw new o.A("knowledge-graph:no-type-name","You must indicate the entity/relationship named object type to apply edits - delete");const t=i.make_delete_helper(e.typeName,!1);e.ids?.forEach((e=>{t.delete_by_id(e)}))})),i.encode()}catch(ot){throw new o.A("knowledge-graph:applyEdits-encoding-failed","Attempting to encode the applyEdits failed",{error:ot})}const a=i.get_encoding_result();return Et(a.error,"knowledge-graph:applyEdits-encoding-failed","Attempting to encode the applyEdits failed"),a.get_byte_buffer()}async function kt(e,t){const n=await V(),r=new n.GraphQueryRequestEncoder;if(r.deleteLater(),r.output_spatial_reference=n.SpatialReferenceUtil.WGS84(),r.open_cypher_query=e.openCypherQuery,e.bindParameters)for(const[o,a]of Object.entries(e.bindParameters))It(o,a,r,n);if(e.bindGeometryQuantizationParameters)se(e.bindGeometryQuantizationParameters,r);else{if(t.dataModel||await wt(t),4326!==t.dataModel?.spatialReference?.wkid)throw new o.A("knowledge-graph:SR-quantization-mismatch","If the DataModel indicates a coordinate system other than WGS84, inputQuantizationParameters must be provided to the query encoder");r.input_quantization_parameters=n.InputQuantizationUtil.WGS84_lossless()}e.outputQuantizationParameters&&le(e.outputQuantizationParameters,r,n);try{r.encode()}catch(T){throw new o.A("knowledge-graph:query-encoding-failed","Attempting to encode the query failed",{error:T})}const i=r.get_encoding_result();if(0!==i.error.error_code)throw new o.A("knowledge-graph:query-encoding-failed","Attempting to encode the query failed",{errorCode:i.error.error_code,errorMessage:i.error.error_message});return i.get_byte_buffer()}async function vt(e){const t=await V(),n=new t.GraphSearchRequestEncoder;if(n.deleteLater(),n.search_query=e.searchQuery,n.type_category_filter=t.esriNamedTypeCategory[e.typeCategoryFilter],!0===e.returnSearchContext&&(n.return_search_context=e.returnSearchContext),null!=e.start&&e.start>0&&(n.start_index=e.start),null!=e.num&&(n.max_num_results=e.num),null!=e.idsFilter&&Array.isArray(e.idsFilter)&&e.idsFilter.length>0)try{n.set_ids_filter(ie(e.idsFilter,t))}catch(K){throw new o.A("knowledge-graph:ids-format-error","Attempting to set ids filter failed.  This is usually caused by an incorrectly formatted UUID string",{error:K})}e.namedTypesFilter?.forEach((e=>{n.add_named_type_filter(e)}));try{n.encode()}catch(K){throw new o.A("knowledge-graph:search-encoding-failed","Attempting to encode the search failed",{error:K})}const r=n.get_encoding_result();if(0!==r.error.error_code)throw new o.A("knowledge-graph:search-encoding-failed","Attempting to encode the search failed",{errorCode:r.error.error_code,errorMessage:r.error.error_message});return r.get_byte_buffer()}async function Ct(e,t){return(0,x["default"])(e,{responseType:"native-request-init",method:"post",query:{f:"pbf",...t?.query},body:"x",headers:{"Content-Type":"application/octet-stream"},signal:t?.signal,timeout:t?.timeout})}async function Lt(e){const t=e.headers.get("content-type");if(t?.includes("application/x-protobuf")){const t=await e.arrayBuffer(),n=new((await V()).GraphApplyEditsDecoder);return n.deleteLater(),n.decode(new Uint8Array(t)),ft(n)}throw new o.A("knowledge-graph:unexpected-server-response","server returned an unexpected response",{responseType:t,data:e.text()})}function At(e,t,n){e.push_buffer(new Uint8Array(t));const r=[];let i=0;for(;e.next_row();){i||(i=e.get_header_keys().size());const t=new Array(i);for(let r=0;r<i;r++){const i=e.get_value(r);t[r]=st(i,n)}r.push(t)}if(e.has_error())throw new o.A("knowledge-graph:stream-decoding-error","One or more result rows were not successfully decoded",{errorCode:e.error.error_code,errorMessage:e.error.error_message});return r}async function Dt(e,t){const n=e.headers.get("content-type");if(e.headers.get("content-length")&&a.A.getLogger("geoscene.rest.knowledgeGraph.knowledgeGraphService").warnOnce("Found `Content-Length` header when expecting a streaming HTTP response! Please investigate whether all intermediate HTTP proxies and/or load balancers are configured such that they don't forcefully buffer the entire response before returning it to the client. A valid HTTP streaming response should use Chunked Transfer Encoding and not have a Content Length defined."),n?.includes("application/x-protobuf")){const n=e.body?.getReader(),r=new((await V()).GraphQueryDecoder);return r.deleteLater(),new ReadableStream({async start(e){try{return i()}catch(T){n?.releaseLock(),e.error(new o.A("knowledge-graph:stream-decoding-error","The server returned a valid response, but there was an error decoding the response stream",{error:T})),e.close()}function i(){return n?.read().then((({done:a,value:s})=>{if(a){let t;if(r.has_error()&&(t=new o.A("knowledge-graph:stream-decoding-error","One or more result rows were not successfully decoded",{errorCode:r.error.error_code,errorMessage:r.error.error_message})),n.releaseLock(),t)throw e.error(t),t;return void e.close()}const l=At(r,s,t);return l.length>0&&e.enqueue(l),i()}))}}})}throw new o.A("knowledge-graph:unexpected-server-response","server returned an unexpected response",{responseType:n,data:e.text()})}async function Gt(e){const t=`${e.url}/dataModel/queryDataModel`,n=await(0,x["default"])(t,{responseType:"array-buffer",query:{f:"pbf"}}),r=n.getHeader?.("content-type"),i=n.data;if(r?.includes("application/x-protobuf")){const e=(await V()).decode_data_model_from_protocol_buffer(new Uint8Array(i));if(!e)throw new o.A("knowledge-graph:data-model-decode-failure","The server responded to the data model query, but the response failed to be decoded.  This typically occurs when the Knowledge JS API (4.26 or later) is used with an unsupported backend (11.0 or earlier)");return Se(e)}throw new o.A("knowledge-graph:unexpected-server-response","server returned an unexpected response",{responseType:r,data:n.data})}let St=class extends f.A{constructor(e){super(e),this.openCypherQuery=""}};(0,r._)([(0,l.MZ)()],St.prototype,"openCypherQuery",void 0),St=(0,r._)([(0,p.$)("geoscene.rest.knowledgeGraph.GraphQuery")],St);const Rt=St;let Nt=class extends Rt{constructor(e){super(e),this.bindParameters=null,this.bindGeometryQuantizationParameters=null,this.outputQuantizationParameters=null}};(0,r._)([(0,l.MZ)()],Nt.prototype,"bindParameters",void 0),(0,r._)([(0,l.MZ)()],Nt.prototype,"bindGeometryQuantizationParameters",void 0),(0,r._)([(0,l.MZ)()],Nt.prototype,"outputQuantizationParameters",void 0),Nt=(0,r._)([(0,p.$)("geoscene.rest.knowledgeGraph.GraphQueryStreaming")],Nt);const jt=Nt;var Ft=n(81809);const Pt="ESRI__ID",Ot="ESRI__ORIGIN_ID",Zt="ESRI__DESTINATION_ID",Bt="ESRI__LAYOUT_GEOMETRY",Yt=12,Qt=a.A.getLogger("geoscene.rest.knowledgeGraph.knowledgeGraphLayer.KnowledgeGraphLayerDataManager");let zt=class extends f.A{constructor(e){super(e),this.inclusionModeDefinition={generateAllSublayers:!0,namedTypeDefinitions:new Map},this.entityTypeNames=new Set,this.relationshipTypeNames=new Set,this.geographicLookup=new Map,this.sublayerCaches=new Map,this._processingCacheUpdatesLookup=new Map,this._memberIdTypeLookup=new Map;const t=new Map;e.knowledgeGraph.dataModel.entityTypes?.forEach((n=>{n.name&&(t.set(n.name,"entity"),this._processingCacheUpdatesLookup.set(n.name,[]),e.inclusionModeDefinition&&!e.inclusionModeDefinition?.generateAllSublayers||this.entityTypeNames.add(n.name),n.properties?.forEach((e=>{e.geometryType&&"esriGeometryNull"!==e.geometryType&&this.geographicLookup.set(n.name,{name:e.name??"",geometryType:e.geometryType})})))})),e.knowledgeGraph.dataModel.relationshipTypes?.forEach((n=>{n.name&&(t.set(n.name,"relationship"),this._processingCacheUpdatesLookup.set(n.name,[]),e.inclusionModeDefinition&&!e.inclusionModeDefinition?.generateAllSublayers||this.relationshipTypeNames.add(n.name),n.properties?.forEach((e=>{e.geometryType&&"esriGeometryNull"!==e.geometryType&&this.geographicLookup.set(n.name,{name:e.name??"",geometryType:e.geometryType})})))})),e.inclusionModeDefinition?.namedTypeDefinitions.forEach(((n,r)=>{if("entity"===t.get(r))this.entityTypeNames.add(r);else{if("relationship"!==t.get(r))return Qt.warn(`A named type, ${r}, was in the inclusion list that wasn't in the data model and will be removed`),void e.inclusionModeDefinition?.namedTypeDefinitions.delete(r);this.relationshipTypeNames.add(r)}const i=new Map;n.members?.forEach((e=>{this._memberIdTypeLookup.set(e.id,r);const t=this.getById(e.id);t&&i.set(e.id,t)})),this.sublayerCaches.set(r,i)}))}addToLayerInclusionSet(e){e.forEach((({typeName:e,id:t})=>{if(!this.inclusionModeDefinition)throw new o.A("knowledge-graph:layer-data-manager","You cannot add to a layer's exclusion list if it was not created with an exclusion list originally");if(this.inclusionModeDefinition.namedTypeDefinitions.has(e)){if(this.inclusionModeDefinition.namedTypeDefinitions.has(e)){const n=this.inclusionModeDefinition.namedTypeDefinitions.get(e);if(n.useAllData)throw new o.A("knowledge-graph:layer-data-manager","You cannot add members to an exclusion list for a sublayer where the sublayer is set to always retrieve its entire data set");n.members||(n.members=new Map),n.members.set(t,{id:t}),this._memberIdTypeLookup.set(t,e)}}else{const n=new Map;n.set(t,{id:t}),this.inclusionModeDefinition.namedTypeDefinitions.set(e,{useAllData:!1,members:n}),this._memberIdTypeLookup.set(t,e)}}))}getById(e){return E.getInstance().readFromStoreById(e)}async getData(e,t,n){if(t.objectType.name&&this.inclusionModeDefinition?.namedTypeDefinitions&&this.inclusionModeDefinition.namedTypeDefinitions.size>0&&!this.inclusionModeDefinition.namedTypeDefinitions.has(t.objectType.name))return[];let r;if(r=e||new Ft.A({where:"1=1",outFields:["*"]}),"link-chart"===t.parentCompositeLayer.type){const e=t.parentCompositeLayer,n=this._processingCacheUpdatesLookup.get(t.objectType.name??""),i=r.outFields,o=r.geometry;let a="",s="";o&&o.extent&&(a=(0,h.Qj)(o.extent.ymin,o.extent.xmin,Yt),s=(0,h.Qj)(o.extent.ymax,o.extent.xmax,Yt)),i&&1===i.length&&i[0]===Pt&&"1=1"===r.where||await Promise.all(n??[]);const l=this.sublayerCaches.has(t.objectType.name??"")?Array.from(this.sublayerCaches.get(t.objectType.name)?.values()):[],d=[];return l.forEach((n=>{if(n.geometry=e.linkChartDiagramLookup.get(n.attributes[t.objectIdField]),n.attributes[Bt]=n.geometry,a&&s){const r=e.linkChartGeohashLookup.get(n.attributes[t.objectIdField]);r?r>=a&&r<=s&&d.push(n):d.push(n)}else d.push(n)})),d}return this.retrieveDataFromService(r,t,n)}async getConnectedRecordIds(e){const t=[],n=[],r=new Map;return e.forEach((e=>{if(this._memberIdTypeLookup.has(e)){const t=this._memberIdTypeLookup.get(e);if(!this.entityTypeNames.has(t))return;r.has(t)?r.get(t)?.push(e):r.set(t,[e])}})),r.forEach(((e,r)=>{const i=`MATCH (n:${r})-[r]-(m) WHERE id(n) IN $ids RETURN id(r), type(r), id(m), labels(m)[0]`,o=new Promise((n=>{(async()=>{const n=(await gt(this.knowledgeGraph,new jt({openCypherQuery:i,bindParameters:{ids:e}}))).resultRowsStream.getReader();try{for(;;){const{done:e,value:r}=await n.read();if(e)break;for(let n=0;n<r.length;n++){const e=r[n];t.push({id:e[0],typeName:e[1]}),t.push({id:e[2],typeName:e[3]})}}}catch(r){if("AbortError"!==r.name)throw r;Qt.info("Request aborted as expected")}})().then((()=>{n()}))}));n.push(o)})),await Promise.all(n),t}async refreshCacheContent(e,t,n,r=!0){const i=E.getInstance(),a=[],s=new Map,l=new Map;this.knowledgeGraph.dataModel.entityTypes?.forEach((e=>{e.name&&l.set(e.name,e)})),this.knowledgeGraph.dataModel.relationshipTypes?.forEach((e=>{e.name&&l.set(e.name,e)})),e||this.inclusionModeDefinition?e?e.forEach((e=>{if(this._memberIdTypeLookup.has(e)){const t=this._memberIdTypeLookup.get(e);s.has(t)?s.get(t)?.push(e):s.set(t,[e])}})):this.inclusionModeDefinition?.namedTypeDefinitions?.forEach(((e,t)=>{e.useAllData?s.set(t,null):e.members&&e.members.forEach((e=>{s.has(t)&&null!==s.get(t)?s.get(t)?.push(e.id):s.set(t,[e.id])}))})):(this.knowledgeGraph.dataModel.entityTypes?.forEach((e=>{e.name&&s.set(e.name,null)})),this.knowledgeGraph.dataModel.entityTypes?.forEach((e=>{e.name&&s.set(e.name,null)})));for(const[d,p]of s){const e=new Promise((e=>{const a=async()=>{const e=new Set,a=[];let s,h="",u=!1;if(t||l.get(d)?.properties?.forEach((t=>{t.name&&e.add(t.name)})),n&&this.geographicLookup.has(d)){const t=this.geographicLookup.get(d)?.name;t&&e.add(t)}if(this.entityTypeNames.has(d))h=`MATCH (n:${d}) ${p?"WHERE id(n) IN $ids ":""}return ID(n)`,e.forEach((e=>{h+=`, n.${e}`,a.push(e)}));else{if(!this.relationshipTypeNames.has(d))throw new o.A("knowledge-graph:layer-data-manager",`The graph type of ${d} could not be determined. Was this type set in the KG data model and inclusion definition?`);u=!0,h=`MATCH ()-[n:${d}]->() ${p?"WHERE id(n) IN $ids ":""}return ID(n), id(startNode(n)), id(endNode(n))`,e.forEach((e=>{h+=`, n.${e}`,a.push(e)}))}s=new jt(p?{openCypherQuery:h,bindParameters:{ids:p}}:{openCypherQuery:h});const c=(await gt(this.knowledgeGraph,s)).resultRowsStream.getReader();for(;;){const{done:e,value:t}=await c.read();if(e)break;const n=[];for(let r=0;r<t.length;r++){const e=t[r];let i=0,o=0;const s={properties:{}};for(s.id=e[i],i++,o++,u&&(s.originId=e[i],i++,o++,s.destinationId=e[i],i++,o++);i<e.length;i++)s.properties[a[i-o]]=e[i];n.push(s)}const o=i.writeToStore(n,Pt,this.geographicLookup.get(d)?.name);this.sublayerCaches.has(d)||this.sublayerCaches.set(d,new Map),r&&!this.inclusionModeDefinition?.namedTypeDefinitions.has(d)&&this.inclusionModeDefinition?.namedTypeDefinitions.set(d,{useAllData:!1,members:new Map}),r&&!this.inclusionModeDefinition?.namedTypeDefinitions.get(d).members&&(this.inclusionModeDefinition.namedTypeDefinitions.get(d).members=new Map);const s=this.sublayerCaches.get(d);o.forEach((e=>{s?.set(e.attributes[Pt],e),r&&!this.inclusionModeDefinition?.namedTypeDefinitions.get(d).members.has(e.attributes[Pt])&&(this.inclusionModeDefinition?.namedTypeDefinitions.get(d).members.set(e.attributes[Pt],{id:e.attributes[Pt]}),this._memberIdTypeLookup.set(e.attributes[Pt],d))}))}};a().then((()=>{e(null)}))}));a.push(e),this._processingCacheUpdatesLookup.get(d)?.push(e)}await Promise.all(a)}removeFromLayer(e){const t=new Set;e.forEach((e=>{this._memberIdTypeLookup.get(e)&&t.add(this._memberIdTypeLookup.get(e)),this._memberIdTypeLookup.delete(e),this.inclusionModeDefinition?.namedTypeDefinitions.forEach((t=>{t.members?.has(e)&&t.members.delete(e)}))})),t.forEach((t=>{this.sublayerCaches.get(t)?.forEach(((n,r)=>{e.includes(r)&&this.sublayerCaches.get(t)?.delete(r)}))}))}async retrieveDataFromService(e,t,n){const r=E.getInstance(),i=new Set,o=[];let a,s="",l=[];const d="relationship"===t.graphType,p=this.inclusionModeDefinition?.namedTypeDefinitions?.get(t.objectType.name)?.useAllData,h=t.parentCompositeLayer.sublayerIdsCache.get(t.objectType.name);let u=!p&&h?Array.from(h).sort():null;if(this.inclusionModeDefinition?.namedTypeDefinitions?.get(t.objectType.name)?.useAllData)this.inclusionModeDefinition?.namedTypeDefinitions?.get(t.objectType.name)?.useAllData&&null!=e.objectIds&&(u=e.objectIds);else if(null!=e.objectIds&&u&&u.length>0){const t=e.objectIds;e.objectIds=u.filter((e=>t.includes(e)))}else if(null!=e.objectIds)u=e.objectIds;else{if(this.inclusionModeDefinition?.namedTypeDefinitions.has(t.objectType.name)&&(!this.inclusionModeDefinition.namedTypeDefinitions.get(t.objectType.name)?.members||this.inclusionModeDefinition.namedTypeDefinitions.get(t.objectType.name)?.members?.size<1))return e.objectIds=[],[];e.objectIds=u}if(null!=e.outFields){const n=e.outFields;n.includes("*")?t.fields.forEach((e=>{i.add(e.name)})):n.forEach((e=>{e!==Pt&&e!==t.geometryFieldName&&i.add(e)}))}if(null!=e.geometry){const n=e.geometry;let r;if(n?.extent?.spatialReference&&!n.spatialReference?.isWGS84?(await(0,_.initializeProjection)(n.extent.spatialReference,w.w5),r=(0,_.Cv)(n.extent,w.w5)):r=n.extent,null!=e.where&&"1=1"!==e.where){const n=await(0,m.G)(e.where.toUpperCase(),t.fieldsIndex);t.fields.forEach((e=>{n.fieldNames.includes(e.name)&&i.add(e.name)}))}s=d?`Match ()-[n:${t.objectType.name}]->() WHERE geoscene.graph.ST_Intersects($param_filter_geom, n.${t.geometryFieldName}) return ID(n), id(startNode(r)), id(endNode(r))`:`Match (n:${t.objectType.name}) WHERE geoscene.graph.ST_Intersects($param_filter_geom, n.${t.geometryFieldName}) return ID(n)`,t.geometryFieldName&&i.add(t.geometryFieldName),i.forEach((e=>{s+=`, n.${e}`,o.push(e)})),a=new jt({openCypherQuery:s,bindParameters:{param_filter_geom:new g.A({rings:[[[r.xmin,r.ymin],[r.xmin,r.ymax],[r.xmax,r.ymax],[r.xmax,r.ymin],[r.xmin,r.ymin]]]})}})}else{let n="";if(null!=e.where&&"1=1"!==e.where){const r=await(0,m.G)(e.where,t.fieldsIndex);t.fields.forEach((e=>{r.fieldNames.includes(e.name)&&i.add(e.name)}));const o=["column-reference","string","number","binary-expression"],a=["=","<","<=","<>",">",">=","AND","OR","LIKE"];let s=!1;const l=e=>{if("column-reference"===e.type)return`n.${e.column}`;if("string"===e.type)return`'${e.value}'`;if("number"===e.type)return`${e.value}`;if("binary-expression"===e.type&&o.includes(e.left.type)&&o.includes(e.right.type)&&a.includes(e.operator))return`${l(e.left)} ${e.operator} ${l(e.right)}`;if("binary-expression"===e.type&&"LIKE"===e.operator){let t="";if("function"===e.left.type&&"column-reference"===e.left.args.value[0].type)t+=`lower(n.${e.left.args.value[0].column})`;else{if("column-reference"!==e.left.type)return s=!0,"";t+=`lower(n.${e.left.column})`}if(t+=" CONTAINS (","string"!==e.right.type)return s=!0,"";{let n=e.right.value;"%"===n.charAt(0)&&(n=n.slice(1)),"%"===n.charAt(n.length-1)&&(n=n.slice(0,-1)),t+=`'${n.toLowerCase()}')`}return t}return s=!0,""};n=l(r.parseTree),s&&(n="")}let r="";r=d?`Match ()-[n:${t.objectType.name}]->()`:`Match (n:${t.objectType.name})`;let s=!1;u&&(s=!0,r+=" WHERE ID(n) IN $ids"),n&&(r+=s?" AND":" WHERE",r+=` ${n}`),r+=" return ID(n)",d&&(r+=", id(startNode(n)), id(endNode(n))"),e.returnGeometry&&t.geometryFieldName&&i.add(t.geometryFieldName),i.forEach((e=>{r+=`, n.${e}`,o.push(e)})),a=new jt(u?{openCypherQuery:r,bindParameters:{ids:u}}:{openCypherQuery:r})}const c=(await gt(t.parentCompositeLayer.dataManager.knowledgeGraph,a,n)).resultRowsStream.getReader();for(;;){const{done:e,value:n}=await c.read();if(e)break;const i=[];for(let t=0;t<n.length;t++){const e=n[t];let r=0,a=0;const s={properties:{}};for(s.id=e[r],r++,a++,d&&(s.originId=e[r],r++,a++,s.destinationId=e[r],r++,a++);r<e.length;r++)s.properties[o[r-a]]=e[r];i.push(s)}l=l.concat(r.writeToStore(i,Pt,t.parentCompositeLayer.dataManager.geographicLookup.get(t.objectType.name)?.name))}return l}};(0,r._)([(0,l.MZ)()],zt.prototype,"knowledgeGraph",void 0),(0,r._)([(0,l.MZ)()],zt.prototype,"inclusionModeDefinition",void 0),(0,r._)([(0,l.MZ)()],zt.prototype,"entityTypeNames",void 0),(0,r._)([(0,l.MZ)()],zt.prototype,"relationshipTypeNames",void 0),(0,r._)([(0,l.MZ)()],zt.prototype,"geographicLookup",void 0),(0,r._)([(0,l.MZ)()],zt.prototype,"sublayerCaches",void 0),zt=(0,r._)([(0,p.$)("geoscene.rest.knowledgeGraph.knowledgeGraphLayer.KnowledgeGraphLayerDataManager")],zt);var Ut=n(3035),$t=(n(22070),n(118),n(92223),n(65907),n(71824),n(2882),n(65092),n(44829),n(11066)),qt=n(23928),Ht=(n(7533),n(29153)),Xt=n(86121),Jt=n(37238),Wt=n(56408);const Vt=(0,Wt.p)(),Kt=e=>{let t=class extends e{constructor(){super(...arguments),this.fields=[],this.fieldsIndex=null}};return(0,r._)([(0,l.MZ)(Vt.fields)],t.prototype,"fields",void 0),(0,r._)([(0,l.MZ)(Vt.fieldsIndex)],t.prototype,"fieldsIndex",void 0),t=(0,r._)([(0,p.$)("geoscene.layers.knowledgeGraphLayer.KnowledgeGraphSublayerBase")],t),t};var en=n(79366),tn=n(81315),nn=n(8197),rn=n(99024),on=n(81937),an=n(30104),sn=n(84619),ln=n(55823),dn=n(11910),pn=n(41759),hn=n(11894);let un=class extends((0,tn.J)(Kt((0,en.d)((0,rn.j)((0,nn.J)(u.A)))))){constructor(e){if(super(e),this.capabilities=(0,Jt.f)(!1,!1),this.definitionExpression="",this.displayField="",this.elevationInfo=null,this.geometryType=null,this.geometryFieldName=null,this.graphType=null,this.hasM=!1,this.hasZ=!1,this.labelsVisible=null,this.labelingInfo=null,this.objectIdField=Pt,this.objectType=null,this.parentCompositeLayer=null,this.popupTemplate=null,this.source={openPorts:()=>this.load().then((()=>{const e=new MessageChannel;return new dn.A(e.port1,{channel:e,client:{queryFeatures:(e,t={})=>{const n=Ft.A.fromJSON(e);return this.queryFeaturesJSON(n,t)}}},(()=>null)),[e.port2]}))},this.type="knowledge-graph-sublayer","link-chart"===e.parentCompositeLayer.type)"relationship"===e.graphType?this.geometryType="polyline":this.geometryType="point",this.geometryFieldName=Bt;else if(e.parentCompositeLayer.dataManager.geographicLookup.get(e.objectType.name)?.geometryType&&"esriGeometryNull"!==e.parentCompositeLayer.dataManager.geographicLookup.get(e.objectType.name)?.geometryType){const t=e.parentCompositeLayer.dataManager.geographicLookup.get(e.objectType.name);this.geometryFieldName=t?.name??null,this.geometryType=t?.geometryType?hn.g.fromJSON(t.geometryType):null;const n=t?.name,r=n?e.objectType.properties?.[n]:null;r?(this.hasM=r.hasM??!1,this.hasZ=r.hasZ??!1):(this.hasM=!1,this.hasZ=!1)}else this.geometryType=null;e.objectType.properties?.forEach((e=>{let t=null,n=e.fieldType;"esriFieldTypeOID"===n&&(n="esriFieldTypeInteger"),this.fields.push(on.A.fromJSON({name:e.name,type:n,alias:e.alias,defaultValue:t,editable:e.editable,nullable:e.nullable}))})),this.fields.push(on.A.fromJSON({name:this.objectIdField,type:"esriFieldTypeString",alias:this.objectIdField,editable:!1})),this._set("fields",[...this.fields]),e.parentCompositeLayer.dataManager.knowledgeGraph.dataModel?.spatialReference&&(this.spatialReference=e.parentCompositeLayer.dataManager.knowledgeGraph.dataModel.spatialReference),"link-chart"===e.parentCompositeLayer.type?"relationship"===e.graphType?this.renderer=(0,$t.r)((0,Jt.F0)(hn.g.toJSON("polyline")).renderer):this.renderer=(0,$t.r)((0,Jt.F0)(hn.g.toJSON("point")).renderer):this.renderer=(0,$t.r)((0,Jt.F0)(hn.g.toJSON(this.geometryType)).renderer)}get defaultPopupTemplate(){return this.createPopupTemplate()}set renderer(e){(0,an.yp)(e,this.fieldsIndex),this._set("renderer",e)}createPopupTemplate(e){return(0,ln.tn)(this,e)}createQuery(){return new Ft.A({where:"1=1",outFields:["*"]})}getField(e){for(let t=0;t<this.fields.length;t++)if(this.fields[t].name===e)return this.fields[t];throw new Error("Field not found")}getFieldDomain(e,t){return null}async queryFeatures(e,t){const{resolvedQuery:n,queryEngine:r}=await this._setupQueryObjects(e),i=sn.A.fromJSON(await r.executeQuery(n.toJSON(),t?.signal));return i.features.forEach((e=>{e.sourceLayer=this})),i}async queryFeaturesJSON(e,t){const{resolvedQuery:n,queryEngine:r}=await this._setupQueryObjects(e);return await r.executeQuery(n.toJSON(),t?.signal)}async queryFeatureCount(e,t){const{resolvedQuery:n,queryEngine:r}=await this._setupQueryObjects(e);return r.executeQueryForCount(n.toJSON(),t?.signal)}async queryExtent(e={},t){const n={...e,returnGeometry:!0},{resolvedQuery:r,queryEngine:i}=await this._setupQueryObjects(n),o=await i.executeQueryForExtent(r.toJSON(),t?.signal);let a;return a=null!=o.extent?.xmin&&null!=o.extent?.xmax&&null!=o.extent?.ymin&&null!=o.extent?.ymax?new pn.A(o.extent):new pn.A,{count:o.count,extent:a}}async queryObjectIds(e,t){const n=Ft.A.from(e);let r;if("link-chart"===this.parentCompositeLayer.type&&this._cachedQueryEngine)r=this._cachedQueryEngine;else{const e=await this.parentCompositeLayer.dataManager.getData(n,this,t);r=this.loadQueryEngine(e)}return r.executeQueryForIds(n.toJSON(),t?.signal)}loadQueryEngine(e){const t=new Ht.A({geometryType:hn.g.toJSON(this.geometryType),hasM:this.hasM,hasZ:this.hasZ}),n=new Xt.d({fields:this.fields.map((e=>e.toJSON())),geometryType:hn.g.toJSON(this.geometryType),hasM:this.hasM,hasZ:this.hasZ,objectIdField:this.objectIdField,spatialReference:this.spatialReference.toJSON(),timeInfo:null,featureStore:t});return n.featureStore.addMany(e),n}async refreshCachedQueryEngine(){const e=await this.parentCompositeLayer.dataManager.getData(new Ft.A({where:"1=1",outFields:[Pt]}),this);this._cachedQueryEngine=this.loadQueryEngine(e)}async _setupQueryObjects(e,t){const n=Ft.A.from(e),r=n.geometry;let i;if(r&&!r.spatialReference?.isWGS84&&(await(0,_.initializeProjection)(r.spatialReference,w.w5),n.geometry=(0,_.Cv)(r instanceof g.A||r instanceof ne.A?r:r.extent,w.w5)),"link-chart"===this.parentCompositeLayer.type&&this._cachedQueryEngine)i=this._cachedQueryEngine;else{const e=await this.parentCompositeLayer.dataManager.getData(n,this,t);i=this.loadQueryEngine(e)}return{resolvedQuery:n,queryEngine:i}}};(0,r._)([(0,l.MZ)()],un.prototype,"capabilities",void 0),(0,r._)([(0,l.MZ)({readOnly:!0})],un.prototype,"defaultPopupTemplate",null),(0,r._)([(0,l.MZ)()],un.prototype,"definitionExpression",void 0),(0,r._)([(0,l.MZ)()],un.prototype,"displayField",void 0),(0,r._)([(0,l.MZ)()],un.prototype,"elevationInfo",void 0),(0,r._)([(0,l.MZ)()],un.prototype,"geometryType",void 0),(0,r._)([(0,l.MZ)()],un.prototype,"geometryFieldName",void 0),(0,r._)([(0,l.MZ)()],un.prototype,"graphType",void 0),(0,r._)([(0,l.MZ)()],un.prototype,"hasM",void 0),(0,r._)([(0,l.MZ)()],un.prototype,"hasZ",void 0),(0,r._)([(0,l.MZ)()],un.prototype,"labelsVisible",void 0),(0,r._)([(0,l.MZ)()],un.prototype,"labelingInfo",void 0),(0,r._)([(0,l.MZ)()],un.prototype,"objectIdField",void 0),(0,r._)([(0,l.MZ)()],un.prototype,"objectType",void 0),(0,r._)([(0,l.MZ)()],un.prototype,"parentCompositeLayer",void 0),(0,r._)([(0,l.MZ)({type:Ut.A,json:{name:"popupInfo",write:!0}})],un.prototype,"popupTemplate",void 0),(0,r._)([(0,l.MZ)({types:qt.H,json:{write:{target:"layerDefinition.drawingInfo.renderer"}}})],un.prototype,"renderer",null),(0,r._)([(0,l.MZ)()],un.prototype,"source",void 0),(0,r._)([(0,l.MZ)({json:{read:!1}})],un.prototype,"type",void 0),un=(0,r._)([(0,p.$)("geoscene.layers.knowledgeGraph.KnowledgeGraphSublayer")],un);const cn=un;let yn,fn=null;function mn(){return yn||(yn=n.e(1678).then(n.bind(n,61678)).then((e=>e.l)).then((({default:e})=>e({locateFile:e=>(0,H.s)(`geoscene/libs/linkchartlayout/${e}`)}))).then((e=>{gn(e)})),yn)}function gn(e){fn=e}var _n;function wn(e,t,n,r,i,o){const a=n.length,s=i.length,l=Float64Array.BYTES_PER_ELEMENT,d=Uint32Array.BYTES_PER_ELEMENT,p=Uint8Array.BYTES_PER_ELEMENT,h=16,u=h-1+a*(p+2*l)+s*(2*d),c=fn._malloc(u);try{const p=c+h-c%h,u=p+a*l,y=u+a*l,f=y+s*d,m=f+s*d,g=()=>[fn.HEAPF64.subarray(p>>3,(p>>3)+a),fn.HEAPF64.subarray(u>>3,(u>>3)+a),fn.HEAPU32.subarray(y>>2,(y>>2)+s),fn.HEAPU32.subarray(f>>2,(f>>2)+s),fn.HEAPU8.subarray(m,m+a)],[_,w,M,b,T]=g();_.set(n),w.set(r),M.set(i),b.set(o),T.set(t);const E=e(a,m,p,u,s,y,f),[I,x,k,v,C]=g();return n.set(I),r.set(x),i.set(k),o.set(v),t.set(C),E}finally{fn._free(c)}}!function(e){e[e.None=0]="None",e[e.IsMovable=1]="IsMovable",e[e.IsGeographic=2]="IsGeographic",e[e.IsRoot=4]="IsRoot"}(_n||(_n={}));const Mn=2,bn=1,Tn=-1;var En,In,xn,kn,vn,Cn,Ln,An;!function(e){function t(){return fn.getMinIdealEdgeLength()}function n(e,t,n,r,i,o=Mn,a=bn,s=Tn){return wn(((e,t,n,r,i,l,d)=>fn.applyForceDirectedLayout(e,t,n,r,i,l,d,o,a,s)),e,t,n,r,i)}e.getMinIdealEdgeLength=t,e.apply=n}(En||(En={})),function(e){function t(e,t,n,r,i,o=Mn,a=bn,s=Tn){return wn(((e,t,n,r,i,l,d)=>fn.applyCommunityLayout(e,t,n,r,i,l,d,o,a,s)),e,t,n,r,i)}e.apply=t}(In||(In={})),function(e){function t(e,t,n,r,i){return wn(fn.applySimpleLayout,e,t,n,r,i)}e.apply=t}(xn||(xn={})),function(e){function t(e,t,n,r,i){return wn(fn.applyHierarchicalLayout,e,t,n,r,i)}e.apply=t}(kn||(kn={})),function(e){function t(e,t,n,r,i){return wn(fn.applyRadialTreeLayout,e,t,n,r,i)}e.apply=t}(vn||(vn={})),function(e){function t(e,t,n,r,i){return wn(fn.applySmartTreeLayout,e,t,n,r,i)}e.apply=t}(Cn||(Cn={})),function(e){e[e.Undirected=0]="Undirected",e[e.Directed=1]="Directed",e[e.Reversed=2]="Reversed"}(Ln||(Ln={})),function(e){e[e.ByCC_Raw=0]="ByCC_Raw",e[e.ByCC_NormalizeGlobally=1]="ByCC_NormalizeGlobally",e[e.ByCC_NormalizeByCC=2]="ByCC_NormalizeByCC"}(An||(An={}));const Dn=(e,t,n)=>(e.has(t)||e.set(t,n()),e.get(t));let Gn=class extends((0,en.d)((0,rn.j)(u.A))){constructor(e){if(super(e),this.dataPreloadedInLocalCache=!1,this._currentLinkChartConfig={layoutMode:"RADIAL_TREE",xScaleFactor:1,yScaleFactor:1},this._graphTypeLookup=new Map,this.layers=new i.A,this.linkChartDiagramLookup=new Map,this.linkChartExtent=new pn.A({xmin:-1e-7,ymin:-1e-7,xmax:1e-7,ymax:1e-7}),this.linkChartGeohashLookup=new Map,this.sublayerIdsCache=new Map,this.tables=new i.A,this.type="link-chart",this._originalInclusionList=e.inclusionModeDefinition,e.dataPreloadedInLocalCache&&!e.inclusionModeDefinition)throw new o.A("knowledge-graph:linkchart-layer-constructor","If creating a link chart composite layer and configured that data is already loaded in the cache, you must specify an inclusion list so the Composite Layer knows what records belong to it")}normalizeCtorArgs(e){return{url:e.url,title:e.title,dataPreloadedInLocalCache:e.dataPreloadedInLocalCache,defaultLinkChartConfig:e.defaultLinkChartConfig}}_initializeLayerProperties(e){if(!this.title&&this.url){const e=this.url.split("/");this.title=e[e.length-2]}const t=new Set;let n=[],r=[];if(e.inclusionModeDefinition&&(!e.inclusionModeDefinition.namedTypeDefinitions||e.inclusionModeDefinition.namedTypeDefinitions.size<1))throw new o.A("knowledge-graph:composite-layer-constructor","If an explicit inclusion definition is defined, at least one namedTypeDefinition must also be defined");e.knowledgeGraph.dataModel.entityTypes?.forEach((e=>{e.name&&this._graphTypeLookup.set(e.name,e)})),e.knowledgeGraph.dataModel.relationshipTypes?.forEach((e=>{e.name&&this._graphTypeLookup.set(e.name,e)})),e.inclusionModeDefinition?.generateAllSublayers?(n=e.knowledgeGraph.dataModel.entityTypes??[],r=e.knowledgeGraph.dataModel.relationshipTypes??[]):e.inclusionModeDefinition?.namedTypeDefinitions&&e.inclusionModeDefinition?.namedTypeDefinitions.size>0?e.inclusionModeDefinition?.namedTypeDefinitions.forEach(((i,o)=>{if(!this._graphTypeLookup.get(o))return a.A.getLogger(this).warn(`A named type, ${o}, was in the inclusion list that wasn't in the data model and will be removed`),void e.inclusionModeDefinition?.namedTypeDefinitions.delete(o);this._graphTypeLookup.get(o)instanceof B||"strictOrigin"in this._graphTypeLookup.get(o)?t.has(o)||(t.add(o),r.push(this._graphTypeLookup.get(o))):this._graphTypeLookup.get(o)instanceof O||"properties"in this._graphTypeLookup.get(o)?t.has(o)||(t.add(o),n.push(this._graphTypeLookup.get(o))):(a.A.getLogger(this).warn(`A named type, ${o}, was in the inclusion list that wasn't properly modeled and will be removed`),e.inclusionModeDefinition?.namedTypeDefinitions.delete(o))})):(n=e.knowledgeGraph.dataModel.entityTypes??[],r=e.knowledgeGraph.dataModel.relationshipTypes??[]);const i=new zt({knowledgeGraph:e.knowledgeGraph,inclusionModeDefinition:e.inclusionModeDefinition});this.knowledgeGraph=e.knowledgeGraph,this.memberEntityTypes=n,this.memberRelationshipTypes=r,this.dataManager=i}load(e){return this.addResolvingPromise(new Promise((t=>{_t(this.url).then((n=>{if(this._initializeLayerProperties({knowledgeGraph:n,inclusionModeDefinition:this._originalInclusionList}),this.dataManager.inclusionModeDefinition?.namedTypeDefinitions?.size||(this.dataManager.inclusionModeDefinition={generateAllSublayers:!1,namedTypeDefinitions:new Map},this.dataManager.knowledgeGraph.dataModel.entityTypes?.forEach((e=>{e.name&&this.dataManager.inclusionModeDefinition?.namedTypeDefinitions.set(e.name,{useAllData:!0})})),this.dataManager.knowledgeGraph.dataModel.relationshipTypes?.forEach((e=>{e.name&&this.dataManager.inclusionModeDefinition?.namedTypeDefinitions.set(e.name,{useAllData:!0})}))),this.dataPreloadedInLocalCache)this.loadLayerAssumingLocalCache(),this.dataManager.inclusionModeDefinition&&(this.dataManager.inclusionModeDefinition.generateAllSublayers=!1),this.dataManager.inclusionModeDefinition?.namedTypeDefinitions.forEach((e=>{e.useAllData=!1,e.members?.forEach((e=>{let t;t=e.linkChartLocation instanceof y.A?e.linkChartLocation:e.linkChartLocation?(0,c.Ux)(e.linkChartLocation):null,this.linkChartDiagramLookup.set(e.id,t),t&&2===t.coords.length&&0===t.lengths.length?this.linkChartGeohashLookup.set(e.id,(0,h.Qj)(t.coords[1],t.coords[0],Yt)):this.linkChartGeohashLookup.set(e.id,"")})),this.addResolvingPromise(this._initializeDiagram().then((async()=>{this.layers.forEach((async e=>{await e.refreshCachedQueryEngine()})),this.tables.forEach((async e=>{await e.refreshCachedQueryEngine()}))})))}));else{const t="GEOGRAPHIC"===this.defaultLinkChartConfig?.layoutMode;this.addResolvingPromise(this.dataManager.refreshCacheContent(void 0,!1,t,!0).then((async()=>{(0,s.Te)(e);const t=[],n=[];this.loadLayerAssumingLocalCache(),this.dataManager.inclusionModeDefinition&&(this.dataManager.inclusionModeDefinition.generateAllSublayers=!1,this.dataManager.inclusionModeDefinition.namedTypeDefinitions.forEach((e=>{e.useAllData=!1}))),await this._initializeDiagram(),this.layers.forEach((e=>{n.push(e.refreshCachedQueryEngine()),t.push(new Promise((t=>{e.on("layerview-create",(()=>{t(null)}))})))})),this.tables.forEach((e=>{n.push(e.refreshCachedQueryEngine())})),await Promise.all(n)})))}t(null)}))}))),Promise.resolve(this)}async addRecords(e){await this._handleNewRecords(e)}async expand(e){const t=await this.dataManager.getConnectedRecordIds(e),n=t.filter((e=>!this.sublayerIdsCache.get(e.typeName)?.has(e.id)));return await this._handleNewRecords(t),{records:n}}loadLayerAssumingLocalCache(){this.memberRelationshipTypes.forEach((e=>{const t=new cn({objectType:e,parentCompositeLayer:this,graphType:"relationship",title:e.name});t.geometryType?this.layers.push(t):this.tables.push(t),this.dataManager.sublayerCaches.has(e.name)||this.dataManager.sublayerCaches.set(e.name,new Map)})),this.memberEntityTypes.forEach((e=>{const t=new cn({objectType:e,parentCompositeLayer:this,graphType:"entity",title:e.name});t.geometryType?this.layers.push(t):this.tables.push(t),this.dataManager.sublayerCaches.has(e.name)||this.dataManager.sublayerCaches.set(e.name,new Map)})),this.dataManager.inclusionModeDefinition?.namedTypeDefinitions&&this.dataManager.inclusionModeDefinition?.namedTypeDefinitions.forEach(((e,t)=>{const n=Dn(this.sublayerIdsCache,t,(()=>new Set));e.members?.forEach((e=>{if(n.add(e.id),e.linkChartLocation)if(e.linkChartLocation instanceof y.A)this.linkChartDiagramLookup.set(e.id,e.linkChartLocation),2===e.linkChartLocation.coords.length&&0===e.linkChartLocation.lengths.length?this.linkChartGeohashLookup.set(e.id,(0,h.Qj)(e.linkChartLocation.coords[1],e.linkChartLocation.coords[0],Yt)):this.linkChartGeohashLookup.set(e.id,"");else{const t=(0,c.Ux)(e.linkChartLocation);this.linkChartDiagramLookup.set(e.id,e.linkChartLocation?t:null),"x"in e.linkChartLocation&&"y"in e.linkChartLocation?this.linkChartGeohashLookup.set(e.id,(0,h.Qj)(e.linkChartLocation.x,e.linkChartLocation.y,Yt)):this.linkChartGeohashLookup.set(e.id,"")}}))}))}async calculateLinkChartLayout(e="RADIAL_TREE",t){const n=[],r=[];this.dataManager.sublayerCaches.forEach(((e,t)=>{this.dataManager.entityTypeNames.has(t)?e.forEach((e=>{n.push({typeName:t,feature:e})})):this.dataManager.relationshipTypeNames.has(t)&&e.forEach((e=>{r.push({typeName:t,feature:e})}))})),this.linkChartDiagramLookup=new Map;const i=new Map,s=new Map,l=new Map,d=new Map,p=new Uint8Array(n.length),u=new Float64Array(n.length),y=new Float64Array(n.length),f=new Uint32Array(r.length),m=new Uint32Array(r.length),g=[],_="FORCE_DIRECTED",w=t?.xScaleFactor??1,M=t?.yScaleFactor??1,b=new pn.A({xmin:-1e-7,ymin:-1e-7,xmax:1e-7,ymax:1e-7});let T,E="FORCE_DIRECTED",I=0,x=0;switch(E="GEOGRAPHIC"===e?_:e,E){case"FORCE_DIRECTED":T=En.apply;break;case"COMMUNITY":T=In.apply;break;case"HIERARCHICAL":T=kn.apply;break;case"RADIAL_TREE":T=vn.apply;break;case"SMART_TREE":T=Cn.apply;break;default:T=xn.apply}n.forEach((({typeName:n,feature:r})=>{if(t?.lockedNodeLocations?.has(r.attributes[Pt])){"GEOGRAPHIC"===e&&this.dataManager.geographicLookup.has(n)?p[I]=_n.IsGeographic:p[I]=_n.None;const i=t.lockedNodeLocations.get(r.attributes[Pt]);u[I]=i.x,y[I]=i.y}else if("GEOGRAPHIC"===e&&this.dataManager.geographicLookup.has(n)){p[I]=_n.IsGeographic;let e=null;const t=r.attributes[this.dataManager.geographicLookup.get(n).name],i=this.dataManager.geographicLookup.get(n)?.geometryType;switch(i){case"esriGeometryPoint":u[I]=t?.x,y[I]=t?.y;break;case"esriGeometryPolygon":e=t?.centroid,null!=e?.x&&null!=e?.y?(u[I]=e.x,y[I]=e.y):p[I]=_n.IsMovable;break;case"esriGeometryPolyline":case"esriGeometryMultipoint":e=t?.extent?.center,null!=e?.x&&null!=e?.y?(u[I]=e.x,y[I]=e.y):p[I]=_n.IsMovable;break;default:p[I]=_n.IsMovable}(null==u[I]||null==y[I]||Number.isNaN(u[I])||Number.isNaN(y[I]))&&(p[I]=_n.IsMovable,u[I]=0,y[I]=0)}else p[I]=_n.IsMovable,u[I]=0,y[I]=0;d.set(r.attributes[Pt],I),g[I]={feature:r,typeName:n},I++}));let k=!1;if(r.forEach((e=>{const t=d.get(e.feature.attributes[Ot]),n=d.get(e.feature.attributes[Zt]);void 0!==t&&void 0!==n?(f[x]=t,m[x]=n,x++):(k=!0,this.linkChartDiagramLookup.set(e.feature.attributes[Ot],null),this.linkChartGeohashLookup.set(e.feature.attributes[Ot],null))})),k&&a.A.getLogger(this).warn("A relationship is a member of this layer that has either origin or destination entity nodes that are not members. The diagram geometry will be set to null"),await mn(),!T(p,u,y,f,m))throw new o.A("knowledge-graph:layout-failed","Attempting to arrange the records in the specified layout failed");for(let o=0;o<g.length;o++){if(p[o]===_n.IsMovable&&(u[o]=u[o]*w,y[o]=y[o]*M),y[o]>84.9999&&(y[o]=84.9999),y[o]<-84.9999&&(y[o]=-84.9999),u[o]>179.9999&&(u[o]=179.9999),u[o]<-179.9999&&(u[o]=-179.9999),g[o].feature.attributes[Bt]=new te.A(u[o],y[o]),i.has(g[o].typeName)){const e=i.get(g[o].typeName);e?.set(g[o].feature.attributes[Pt],g[o].feature)}else{const e=new Map;e.set(g[o].feature.attributes[Pt],g[o].feature),i.set(g[o].typeName,e)}l.set(g[o].feature.attributes[Pt],g[o].feature);const e=(0,c.Ux)(g[o].feature.attributes[Bt]);this.linkChartDiagramLookup.set(g[o].feature.attributes[Pt],g[o].feature.attributes[Bt]?e:null),this.linkChartGeohashLookup.set(g[o].feature.attributes[Pt],(0,h.Qj)(g[o].feature.attributes[Bt].y,g[o].feature.attributes[Bt].x,Yt)),g[o].feature.attributes[Bt].x<b.xmin&&(b.xmin=g[o].feature.attributes[Bt].x),g[o].feature.attributes[Bt].x>b.xmax&&(b.xmax=g[o].feature.attributes[Bt].x),g[o].feature.attributes[Bt].y<b.ymin&&(b.ymin=g[o].feature.attributes[Bt].y),g[o].feature.attributes[Bt].y>b.ymax&&(b.ymax=g[o].feature.attributes[Bt].y)}return this.linkChartExtent.xmin=b.xmin,this.linkChartExtent.xmax=b.xmax,this.linkChartExtent.ymin=b.ymin,this.linkChartExtent.ymax=b.ymax,r.forEach((e=>{const t=g[d.get(e.feature.attributes[Ot])]?.feature.attributes[Bt],n=g[d.get(e.feature.attributes[Zt])]?.feature.attributes[Bt];if(!t||!n)return;const r=new ne.A({paths:[[t.x,t.y],[n.x,n.y]]});if(e.feature.attributes[Bt]=r,s.has(e.typeName)){const t=s.get(e.typeName);t?.set(e.feature.attributes[Pt],e.feature)}else{const t=new Map;t.set(e.feature.attributes[Pt],e.feature),s.set(e.typeName,t)}l.set(e.feature.attributes[Pt],e.feature);const i=(0,c.Ux)(e.feature.attributes[Bt]);this.linkChartDiagramLookup.set(e.feature.attributes[Pt],e.feature.attributes[Bt]?i:null),this.linkChartGeohashLookup.set(e.feature.attributes[Pt],"")})),this._currentLinkChartConfig={layoutMode:e,xScaleFactor:w,yScaleFactor:M},{nodes:i,links:s,idMap:l}}async applyNewLinkChartLayout(e="RADIAL_TREE",t){const n=[];await this.calculateLinkChartLayout(e,t),this.layers.forEach((e=>{n.push(e.refreshCachedQueryEngine())})),await Promise.all(n),this.layers.forEach((e=>{e.emit("refresh",{dataChanged:!0})}))}getCurrentNodeLocations(){const e=new Map;return this.dataManager.inclusionModeDefinition?.namedTypeDefinitions?.forEach((t=>{t?.members?.forEach((t=>{const n=t.linkChartLocation;let r;const i=t.id;n&&(r="x"in n?{x:n.x,y:n.y}:{x:n.coords[0],y:n.coords[1]},e.set(i,new te.A({x:r.x,y:r.y})))}))})),e}async synchronizeInclusionListWithCache(){return new Promise((e=>{this.dataManager.inclusionModeDefinition?.namedTypeDefinitions.forEach(((e,t)=>{if(e.useAllData=!1,e.members&&e.members.size>0){if(!this.dataManager.sublayerCaches.get(t))return;const n=Array.from(this.dataManager.sublayerCaches.get(t).keys());Array.from(e.members.keys()).filter((e=>!n.includes(e))).forEach((t=>{e.members?.delete(t)}))}})),e()}))}async refreshLinkChartCache(e){await this.dataManager.refreshCacheContent(e);const t=[];this.layers.forEach((e=>{t.push(e.refreshCachedQueryEngine())})),await Promise.all(t),this.layers.forEach((e=>{e.emit("refresh",{dataChanged:!0})}))}async _handleNewRecords(e){const t=[];this.dataManager.addToLayerInclusionSet(e);for(const n of e)this.sublayerIdsCache.has(n.typeName)||(this.sublayerIdsCache.set(n.typeName,new Set),t.push(n.typeName)),this.sublayerIdsCache.get(n.typeName).add(n.id);for(const n of t)if(this._graphTypeLookup.has(n)){const e=this._graphTypeLookup.get(n),t="endPoints"in e?"relationship":"entity",r=new cn({objectType:e,parentCompositeLayer:this,graphType:t,title:n});"entity"===t?this.dataManager.entityTypeNames.add(n):this.dataManager.relationshipTypeNames.add(n),r.geometryType?this.layers.push(r):this.tables.push(r),this.dataManager.sublayerCaches.set(n,new Map)}await this.dataManager.refreshCacheContent(e.map((e=>e.id))),await this.applyNewLinkChartLayout(this._currentLinkChartConfig.layoutMode,{xScaleFactor:this._currentLinkChartConfig.xScaleFactor,yScaleFactor:this._currentLinkChartConfig.xScaleFactor})}async _initializeDiagram(){this.defaultLinkChartConfig?this.defaultLinkChartConfig.doNotRecalculateLayout?(this.dataManager.inclusionModeDefinition?.namedTypeDefinitions?.forEach((e=>{e?.members?.forEach((e=>{const t=e.linkChartLocation;let n;const r=e.id;if(!t)return;n="x"in t?{x:t.x,y:t.y}:{x:t.coords[0],y:t.coords[1]};const i=(0,c.Ux)(n);this.linkChartDiagramLookup.set(r,i),this.linkChartGeohashLookup.set(r,(0,h.Qj)(n.x,n.y,Yt)),this.linkChartExtent.xmin>n.x&&(this.linkChartExtent.xmin=n.x),this.linkChartExtent.xmax<n.x&&(this.linkChartExtent.xmax=n.x),this.linkChartExtent.ymin>n.y&&(this.linkChartExtent.ymin=n.y),this.linkChartExtent.ymax<n.y&&(this.linkChartExtent.ymax=n.y)}))})),this.memberRelationshipTypes.forEach((e=>{e.name&&this.dataManager.sublayerCaches.get(e.name)?.forEach((e=>{const t=this.linkChartDiagramLookup.get(e.attributes[Ot]),n=this.linkChartDiagramLookup.get(e.attributes[Zt]);if(t&&n){const r=(0,c.Ux)(new ne.A({paths:[[t.coords[0],t.coords[1]],[n.coords[0],n.coords[1]]]}));this.linkChartDiagramLookup.set(e.attributes[Pt],r)}else this.linkChartDiagramLookup.set(e.attributes[Pt],null);this.linkChartGeohashLookup.set(e.attributes[Pt],"")}))}))):await this.calculateLinkChartLayout(this.defaultLinkChartConfig.layoutMode,{xScaleFactor:this.defaultLinkChartConfig.xScaleFactor,yScaleFactor:this.defaultLinkChartConfig.yScaleFactor,lockedNodeLocations:this.getCurrentNodeLocations()}):await this.calculateLinkChartLayout("RADIAL_TREE",{lockedNodeLocations:this.getCurrentNodeLocations()})}};(0,r._)([(0,l.MZ)()],Gn.prototype,"dataPreloadedInLocalCache",void 0),(0,r._)([(0,l.MZ)()],Gn.prototype,"defaultLinkChartConfig",void 0),(0,r._)([(0,l.MZ)()],Gn.prototype,"dataManager",void 0),(0,r._)([(0,l.MZ)()],Gn.prototype,"knowledgeGraph",void 0),(0,r._)([(0,l.MZ)()],Gn.prototype,"layers",void 0),(0,r._)([(0,l.MZ)()],Gn.prototype,"linkChartDiagramLookup",void 0),(0,r._)([(0,l.MZ)()],Gn.prototype,"linkChartExtent",void 0),(0,r._)([(0,l.MZ)()],Gn.prototype,"linkChartGeohashLookup",void 0),(0,r._)([(0,l.MZ)()],Gn.prototype,"memberEntityTypes",void 0),(0,r._)([(0,l.MZ)()],Gn.prototype,"memberRelationshipTypes",void 0),(0,r._)([(0,l.MZ)()],Gn.prototype,"sublayerIdsCache",void 0),(0,r._)([(0,l.MZ)()],Gn.prototype,"tables",void 0),(0,r._)([(0,l.MZ)({json:{read:!1}})],Gn.prototype,"type",void 0),Gn=(0,r._)([(0,p.$)("geoscene.layers.LinkChartLayer")],Gn);const Sn=Gn},79202:function(e,t,n){n.d(t,{F:function(){return p}});n(44114),n(17642),n(58004),n(33853),n(45876),n(32475),n(15024),n(31698);var r=n(51020),i=n(69843),o=n(99359);const a=5e4,s={minX:0,minY:0,maxX:0,maxY:0};function l(e){s.minX=e[0],s.minY=e[1],s.maxX=e[2],s.maxY=e[3]}function d(e,t,n){l(t),e.search(s,n)}class p{constructor(){this._indexInvalid=!1,this._boundsToLoad=[],this._boundsById=new Map,this._idByBounds=new Map,this._index=new i.w(9,(0,r.A)("geoscene-csp-restrictions")?e=>({minX:e[0],minY:e[1],maxX:e[2],maxY:e[3]}):["[0]","[1]","[2]","[3]"]),this._loadIndex=()=>{if(this._indexInvalid){const e=new Array(this._idByBounds.size);let t=0;this._idByBounds.forEach(((n,r)=>{e[t++]=r})),this._indexInvalid=!1,this._index.clear(),this._index.load(e)}else this._boundsToLoad.length&&(this._index.load(Array.from(new Set(this._boundsToLoad.filter((e=>this._idByBounds.has(e)))))),this._boundsToLoad.length=0)}}get fullBounds(){if(!this._boundsById.size)return null;const e=(0,o.Ie)();for(const t of this._boundsById.values())t&&(e[0]=Math.min(t[0],e[0]),e[1]=Math.min(t[1],e[1]),e[2]=Math.max(t[2],e[2]),e[3]=Math.max(t[3],e[3]));return e}get valid(){return!this._indexInvalid}clear(){this._indexInvalid=!1,this._boundsToLoad.length=0,this._boundsById.clear(),this._idByBounds.clear(),this._index.clear()}delete(e){const t=this._boundsById.get(e);this._boundsById.delete(e),t&&(this._idByBounds.delete(t),this._indexInvalid||this._index.remove(t))}forEachInBounds(e,t){this._loadIndex(),d(this._index,e,(e=>t(this._idByBounds.get(e))))}get(e){return this._boundsById.get(e)}has(e){return this._boundsById.has(e)}invalidateIndex(){this._indexInvalid||(this._indexInvalid=!0,this._boundsToLoad.length=0)}set(e,t){if(!this._indexInvalid){const t=this._boundsById.get(e);t&&(this._index.remove(t),this._idByBounds.delete(t))}this._boundsById.set(e,t),t&&(this._idByBounds.set(t,e),this._indexInvalid||(this._boundsToLoad.push(t),this._boundsToLoad.length>a&&this._loadIndex()))}}},29153:function(e,t,n){n.d(t,{A:function(){return m}});n(17642),n(58004),n(33853),n(45876),n(32475),n(15024),n(31698);var r=n(47966),i=n(20573),o=n(15114),a=n(32604),s=n(99359),l=n(41312),d=n(79202),p=n(99939),h=n(32066),u=n(47086);const c={getObjectId:e=>e.objectId,getAttributes:e=>e.attributes,getAttribute:(e,t)=>e.attributes[t],cloneWithGeometry:(e,t)=>new h.Om(t,e.attributes,null,e.objectId),getGeometry:e=>e.geometry,getCentroid:(e,t)=>(null==e.centroid&&(e.centroid=(0,p.Q)(new u.A,e.geometry,t.hasZ,t.hasM)),e.centroid)};var y=n(79673);const f=(0,a.vt)();class m{constructor(e){this.geometryInfo=e,this._boundsStore=new d.F,this._featuresById=new Map,this._markedIds=new Set,this.events=new i.A,this.featureAdapter=c}get geometryType(){return this.geometryInfo.geometryType}get hasM(){return this.geometryInfo.hasM}get hasZ(){return this.geometryInfo.hasZ}get numFeatures(){return this._featuresById.size}get fullBounds(){return this._boundsStore.fullBounds}get storeStatistics(){let e=0;return this._featuresById.forEach((t=>{null!=t.geometry&&t.geometry.coords&&(e+=t.geometry.coords.length)})),{featureCount:this._featuresById.size,vertexCount:e/(this.hasZ?this.hasM?4:3:this.hasM?3:2)}}getFullExtent(e){if(null==this.fullBounds)return null;const[t,n,r,i]=this.fullBounds;return{xmin:t,ymin:n,xmax:r,ymax:i,spatialReference:(0,y.ag)(e)}}add(e){this._add(e),this._emitChanged()}addMany(e){for(const t of e)this._add(t);this._emitChanged()}clear(){this._featuresById.clear(),this._boundsStore.clear(),this._emitChanged()}removeById(e){const t=this._featuresById.get(e);return t?(this._remove(t),this._emitChanged(),t):null}removeManyById(e){this._boundsStore.invalidateIndex();for(const t of e){const e=this._featuresById.get(t);e&&this._remove(e)}this._emitChanged()}forEachBounds(e,t){for(const n of e){const e=this._boundsStore.get(n.objectId);e&&t((0,a.Jt)(f,e))}}getFeature(e){return this._featuresById.get(e)}has(e){return this._featuresById.has(e)}forEach(e){this._featuresById.forEach((t=>e(t)))}forEachInBounds(e,t){this._boundsStore.forEachInBounds(e,(e=>{t(this._featuresById.get(e))}))}startMarkingUsedFeatures(){this._boundsStore.invalidateIndex(),this._markedIds.clear()}sweep(){let e=!1;this._featuresById.forEach(((t,n)=>{this._markedIds.has(n)||(e=!0,this._remove(t))})),this._markedIds.clear(),e&&this._emitChanged()}_emitChanged(){this.events.emit("changed",void 0)}_add(e){if(!e)return;const t=e.objectId;if(null==t)return void o.A.getLogger("geoscene.layers.graphics.data.FeatureStore").error(new r.A("featurestore:invalid-feature","feature id is missing",{feature:e}));const n=this._featuresById.get(t);let i;if(this._markedIds.add(t),n?(e.displayId=n.displayId,i=this._boundsStore.get(t),this._boundsStore.delete(t)):null!=this.onFeatureAdd&&this.onFeatureAdd(e),null==e.geometry||!e.geometry.coords||!e.geometry.coords.length)return this._boundsStore.set(t,null),void this._featuresById.set(t,e);i=(0,l.jQ)(null!=i?i:(0,s.vt)(),e.geometry,this.geometryInfo.hasZ,this.geometryInfo.hasM),null!=i&&this._boundsStore.set(t,i),this._featuresById.set(t,e)}_remove(e){null!=this.onFeatureRemove&&this.onFeatureRemove(e);const t=e.objectId;return this._markedIds.delete(t),this._boundsStore.delete(t),this._featuresById.delete(t),e}}},37238:function(e,t,n){n.d(t,{F0:function(){return s},Vx:function(){return p},e2:function(){return h},f:function(){return u}});var r=n(51020),i=n(1834),o=n(31004),a=n(25138);function s(e){return{renderer:{type:"simple",symbol:"esriGeometryPoint"===e||"esriGeometryMultipoint"===e?a.Cb:"esriGeometryPolyline"===e?a.yM:a.WR}}}const l=/^[_$a-zA-Z][_$a-zA-Z0-9]*$/;let d=1;function p(e,t){if((0,r.A)("geoscene-csp-restrictions"))return()=>({[t]:null,...e});try{let n=`this.${t} = null;`;for(const t in e)n+=`this${l.test(t)?`.${t}`:`["${t}"]`} = ${JSON.stringify(e[t])};`;const r=new Function(`\n      return class AttributesClass$${d++} {\n        constructor() {\n          ${n};\n        }\n      }\n    `)();return()=>new r}catch(n){return()=>({[t]:null,...e})}}function h(e={}){return[{name:"New Feature",description:"",prototype:{attributes:(0,i.o8)(e)}}]}function u(e,t){return{analytics:{supportsCacheHint:!1},attachment:null,data:{isVersioned:!1,supportsAttachment:!1,supportsM:!1,supportsZ:e},metadata:{supportsAdvancedFieldProperties:!1},operations:{supportsCalculate:!1,supportsTruncate:!1,supportsValidateSql:!1,supportsAdd:t,supportsDelete:t,supportsEditing:t,supportsChangeTracking:!1,supportsQuery:!0,supportsQueryAnalytics:!1,supportsQueryAttachments:!1,supportsQueryTopFeatures:!1,supportsResizeAttachments:!1,supportsSync:!1,supportsUpdate:t,supportsExceedsLimitStatistics:!0,supportsAsyncConvert3D:!1},query:o.F,queryRelated:{supportsCount:!0,supportsOrderBy:!0,supportsPagination:!0,supportsCacheHint:!1},queryTopFeatures:{supportsCacheHint:!1},editing:{supportsGeometryUpdate:t,supportsGlobalId:!1,supportsReturnServiceEditsInSourceSpatialReference:!1,supportsRollbackOnFailure:!1,supportsUpdateWithoutM:!1,supportsUploadWithItemId:!1,supportsDeleteByAnonymous:!1,supportsDeleteByOthers:!1,supportsUpdateByAnonymous:!1,supportsUpdateByOthers:!1,supportsAsyncApplyEdits:!1}}}}}]);
//# sourceMappingURL=7655.edaf0709.js.map