"use strict";(self["webpackChunksun_glare_project"]=self["webpackChunksun_glare_project"]||[]).push([[2614],{37072:function(e,t,r){r.d(t,{a:function(){return o},c:function(){return s},f:function(){return i}});r(16573),r(78100),r(77936),r(37467),r(44732),r(79577);function s(){return[1,0,0,0,1,0,0,0,1]}function n(e){return[e[0],e[1],e[2],e[3],e[4],e[5],e[6],e[7],e[8]]}function i(e,t,r,s,n,i,o,a,l){return[e,t,r,s,n,i,o,a,l]}function o(e,t){return new Float64Array(e,t,9)}Object.freeze(Object.defineProperty({__proto__:null,clone:n,create:s,createView:o,fromValues:i},Symbol.toStringTag,{value:"Module"}))},41997:function(e,t,r){r.d(t,{O:function(){return p},W:function(){return d}});var s=r(13030),n=r(37072),i=r(28589),o=r(67886),a=r(456);const l=(0,a.c)(),c=(0,n.c)(),h=(0,n.c)(),u=(0,n.c)();function d(e,t,r){return(0,o.s)(l,t[0],t[1],1),(0,o.t)(l,l,(0,s.t)(c,r)),0===l[2]?(0,i.s)(e,l[0],l[1]):(0,i.s)(e,l[0]/l[2],l[1]/l[2])}function p(e,t,r){return m(h,t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7]),m(u,r[0],r[1],r[2],r[3],r[4],r[5],r[6],r[7]),(0,s.m)(e,(0,s.a)(h,h),u),0!==e[8]&&(e[0]/=e[8],e[1]/=e[8],e[2]/=e[8],e[3]/=e[8],e[4]/=e[8],e[5]/=e[8],e[6]/=e[8],e[7]/=e[8],e[8]/=e[8]),e}function m(e,t,r,n,i,a,h,u,d){(0,s.s)(e,t,n,a,r,i,h,1,1,1),(0,o.s)(l,u,d,1),(0,s.a)(c,e);const[p,m,f]=(0,o.t)(l,l,(0,s.t)(c,c));return(0,s.s)(c,p,0,0,0,m,0,0,0,f),(0,s.m)(e,c,e)}},13176:function(e,t,r){r.d(t,{_:function(){return u}});var s=r(71457),n=r(3734),i=r(76543),o=(r(37679),r(69292),r(51020),r(29916)),a=r(9737),l=r(78979),c=r(99359),h=r(70620);let u=class extends n.A{constructor(e){super(e)}get bounds(){const e=this.coords;return null==e||null==e.extent?null:(0,c.VY)(e.extent)}get coords(){const e=this.element.georeference?.coords;return(0,l.bS)(e,this.spatialReference).geometry}get normalizedCoords(){return a.A.fromJSON((0,h.jZ)(this.coords))}get normalizedBounds(){const e=null!=this.normalizedCoords?this.normalizedCoords.extent:null;return null!=e?(0,c.VY)(e):null}};(0,s._)([(0,i.MZ)()],u.prototype,"spatialReference",void 0),(0,s._)([(0,i.MZ)()],u.prototype,"element",void 0),(0,s._)([(0,i.MZ)()],u.prototype,"bounds",null),(0,s._)([(0,i.MZ)()],u.prototype,"coords",null),(0,s._)([(0,i.MZ)()],u.prototype,"normalizedCoords",null),(0,s._)([(0,i.MZ)()],u.prototype,"normalizedBounds",null),u=(0,s._)([(0,o.$)("geoscene.layers.support.MediaElementView")],u)},82614:function(e,t,r){r.r(t),r.d(t,{default:function(){return ee}});r(44114),r(43375),r(39225),r(13972),r(99209),r(25714),r(17561),r(66197);var s=r(71457),n=(r(2516),r(11134),r(22070),r(118),r(92223),r(65907),r(71824),r(2882),r(65092),r(44829),r(11066),r(85092),r(41879)),i=(r(51020),r(15114)),o=r(16225),a=r(71120),l=r(87400),c=r(76543),h=(r(37679),r(69292),r(29916)),u=r(99359),d=r(10306),p=r(66340),m=r(13176),f=r(47966),_=(r(70864),r(86039),r(19470),r(52727),r(4244),r(46656),r(32322),r(25124)),y=(r(50221),r(50095),r(54069)),g=(r(32339),r(60824),r(62830),r(913),r(73719)),v=(r(82236),r(28161)),w=(r(11145),r(17),r(62735),r(76036),r(80249),r(72422),r(8792),r(75218),r(64632)),M=(r(99513),r(38153),r(69635)),R=r(79925),x=(r(448),r(29323),r(44077),r(15362),r(26011)),E=(r(45978),r(18972),r(78838)),b=(r(52036),r(396),r(79615),r(1505),r(94499),r(42835),r(44670),r(80155),r(31014),r(46896),r(80545),r(94792),r(29632),r(37459),r(81291),r(73884),r(28284),r(54923),r(45841),r(41312),r(79075),r(59384),r(67779)),V=r(42638),C=(r(40948),r(49067),r(94947),r(66346),r(78546),r(84339),r(12015)),S=r(13590),T=(r(16573),r(78100),r(77936),r(37467),r(44732),r(79577),r(14095)),A=r(79908),q=r(41997),z=r(37072),G=r(28589),D=r(15329),O=r(54703);const P=(0,z.c)();class U extends _.q{constructor(e){super(),this.elementView=e,this.isWrapAround=!1,this.perspectiveTransform=(0,D.a)(),this._vertices=new Float32Array(20),this._handles=[],this._handles.push((0,l.wB)((()=>this.elementView.element.opacity),(e=>this.opacity=e),l.Vh),(0,l.wB)((()=>[this.elementView.coords]),(()=>{this.requestRender()}),l.Vh),(0,l.z7)((()=>this.elementView.element.loaded),(()=>{const e=this.elementView.element;this.ready(),"video"===e.type&&null!=e.content&&this._handles.push((0,T.on)(e.content,"play",(()=>this.requestRender())))}),l.Vh)),e.element.load().catch((t=>{i.A.getLogger("geoscene.views.2d.layers.MediaLayerView2D").error(new f.A("element-load-error","Element cannot be displayed",{element:e,error:t}))}))}destroy(){this._handles.forEach((e=>e.remove())),this.texture=(0,A.WD)(this.texture)}get dvsMat3(){return this.parent.dvsMat3}beforeRender(e){const{context:t}=e,r=this.elementView.element.content;if(null!=r){const e=r instanceof HTMLImageElement,s=r instanceof HTMLVideoElement,n=e?r.naturalWidth:s?r.videoWidth:r.width,i=e?r.naturalHeight:s?r.videoHeight:r.height;if(this._updatePerspectiveTransform(n,i),this.texture)s&&!r.paused&&(this.texture.setData(r),this.requestRender(),(t.type===v.EL.WEBGL2||(0,x.r6)(n)&&(0,x.r6)(i))&&this.texture.generateMipmap());else{const e=new O.R;e.wrapMode=g.pF.CLAMP_TO_EDGE,e.preMultiplyAlpha=!0,e.width=n,e.height=i,this.texture=new M.g(t,e,r),(t.type===v.EL.WEBGL2||(0,x.r6)(n)&&(0,x.r6)(i))&&this.texture.generateMipmap(),s&&!r.paused&&this.requestRender()}}super.beforeRender(e)}_createTransforms(){return null}updateDrawCoords(e,t){const r=this.elementView.coords;if(null==r)return;const[s,n,i,o]=r.rings[0],a=this._vertices,{x:l,y:c}=e,h=0!==t;h?a.set([n[0]-l,n[1]-c,s[0]-l,s[1]-c,i[0]-l,i[1]-c,o[0]-l,o[1]-c,o[0]-l,o[1]-c,n[0]+t-l,n[1]-c,n[0]+t-l,n[1]-c,s[0]+t-l,s[1]-c,i[0]+t-l,i[1]-c,o[0]+t-l,o[1]-c]):a.set([n[0]-l,n[1]-c,s[0]-l,s[1]-c,i[0]-l,i[1]-c,o[0]-l,o[1]-c]),this.isWrapAround=h}getVAO(e,t,r){if(null==this.elementView.coords)return null;const s=this._vertices;if(this._vao)this._geometryVbo.setData(s);else{this._geometryVbo=w.g.createVertex(e,g._U.DYNAMIC_DRAW,s);const n=w.g.createVertex(e,g._U.STATIC_DRAW,new Uint16Array([0,0,0,1,1,0,1,1,1,1,0,0,0,0,0,1,1,0,1,1]));this._vao=new R.Z(e,r,t,{geometry:this._geometryVbo,tex:n})}return this._vao}_updatePerspectiveTransform(e,t){const r=this._vertices;(0,q.O)(P,[0,0,e,0,0,t,e,t],[r[0],r[1],r[4],r[5],r[2],r[3],r[6],r[7]]),(0,G.s)(this.perspectiveTransform,P[6]/P[8]*e,P[7]/P[8]*t)}}var W=r(18513),j=r(13030),L=r(45611),Z=r(72465),I=r(23778),B=r(55828),H=r(6356);class k extends H.A{constructor(){super(...arguments),this._localOrigin=(0,W.tc)(0,0),this._viewStateId=-1,this._dvsMat3=(0,L.c)(),this.requiresDedicatedFBO=!1}get dvsMat3(){return this._dvsMat3}beforeRender(e){this._updateMatrices(e),this._updateOverlays(e,this.children);for(const t of this.children)t.beforeRender(e)}prepareRenderPasses(e){const t=e.registerRenderPass({name:"overlay",brushes:[B.d.overlay],target:()=>this.children,drawPhase:y.S5.MAP});return[...super.prepareRenderPasses(e),t]}_updateMatrices(e){const{state:t}=e,{id:r,size:s,pixelRatio:n,resolution:i,rotation:o,viewpoint:a,displayMat3:l}=t;if(this._viewStateId===r)return;const c=Math.PI/180*o,h=n*s[0],u=n*s[1],{x:d,y:p}=a.targetGeometry,m=(0,V.mT)(d,t.spatialReference);this._localOrigin.x=m,this._localOrigin.y=p;const f=i*h,_=i*u,y=(0,j.g)(this._dvsMat3);(0,j.m)(y,y,l),(0,j.h)(y,y,(0,E.f)(h/2,u/2)),(0,j.d)(y,y,(0,b.f)(h/f,-u/_,1)),(0,j.r)(y,y,-c),this._viewStateId=r}_updateOverlays(e,t){const{state:r}=e,{rotation:s,spatialReference:n,worldScreenWidth:i,size:o,viewpoint:a}=r,l=this._localOrigin;let c=0;const h=(0,Z.Vp)(n);if(h&&n.isWrappable){const e=o[0],u=o[1],d=180/Math.PI*s,p=Math.abs(Math.cos(d)),m=Math.abs(Math.sin(d)),f=Math.round(e*p+u*m),[_,y]=h.valid,g=(0,I.FT)(n),{x:v,y:w}=a.targetGeometry,M=[v,w],R=[0,0];r.toScreen(R,M);const x=[0,0];let E;E=f>i?.5*i:.5*f;const b=Math.floor((v+.5*g)/g),V=_+b*g,C=y+b*g,S=[R[0]+E,0];r.toMap(x,S),x[0]>C&&(c=g),S[0]=R[0]-E,r.toMap(x,S),x[0]<V&&(c=-g);for(const r of t){const e=r.elementView.bounds;if(null==e)continue;const[t,,s]=e;t<_&&s>_?r.updateDrawCoords(l,g):s>y&&t<y?r.updateDrawCoords(l,-g):r.updateDrawCoords(l,c)}}else for(const u of t)u.updateDrawCoords(l,c)}}var Q=r(15235),F=r(48278),Y=r(41759);let N=class extends((0,Q.e)(F.A)){constructor(){super(...arguments),this._overlayContainer=null,this._fetchQueue=null,this._tileStrategy=null,this._elementReferences=new Map,this._debugGraphicsView=null,this.layer=null,this.elements=new n.A}attach(){this.addAttachHandles([(0,l.on)((()=>this.layer.effectiveSource),"refresh",(()=>{this._tileStrategy.refresh((e=>this._updateTile(e))),this.requestUpdate()})),(0,l.on)((()=>this.layer.effectiveSource),"change",(({element:e})=>this._elementUpdateHandler(e)))]),this._overlayContainer=new k,this.container.addChild(this._overlayContainer),this._fetchQueue=new C.A({tileInfoView:this.view.featuresTilingScheme,concurrency:10,process:(e,t)=>this._queryElements(e,t)}),this._tileStrategy=new S.A({cachePolicy:"purge",resampling:!0,acquireTile:e=>this._acquireTile(e),releaseTile:e=>this._releaseTile(e),tileInfoView:this.view.featuresTilingScheme}),this.requestUpdate()}detach(){this.elements.removeAll(),this._tileStrategy.destroy(),this._fetchQueue.destroy(),this._overlayContainer.removeAllChildren(),this.container.removeAllChildren(),this._elementReferences.clear(),this._debugGraphicsView?.destroy()}supportsSpatialReference(e){return!0}moveStart(){this.requestUpdate()}viewChange(){this.requestUpdate()}moveEnd(){this.requestUpdate()}update(e){this._tileStrategy.update(e),this._debugGraphicsView?.update(e)}async hitTest(e,t){const r=[],s=e.normalize(),n=[s.x,s.y];for(const{projectedElement:{normalizedCoords:i,element:o}}of this._elementReferences.values())null!=i&&(0,d.t1)(i.rings,n)&&r.push({type:"media",element:o,layer:this.layer,mapPoint:e});return r.reverse()}canResume(){return null!=this.layer.source&&super.canResume()}async doRefresh(){this._fetchQueue.reset(),this._tileStrategy.refresh((e=>this._updateTile(e)))}_acquireTile(e){const t=new X(e.clone());return this._updateTile(t),t}_updateTile(e){this.updatingHandles.addPromise(this._fetchQueue.push(e.key).then((t=>{const[r,s]=e.setElements(t);this._referenceElements(e,r),this._dereferenceElements(e,s),this.requestUpdate()}),(e=>{(0,a.zf)(e)||i.A.getLogger(this).error(e)})))}_releaseTile(e){this._fetchQueue.abort(e.key.id),e.elements&&this._dereferenceElements(e,e.elements),this.requestUpdate()}async _queryElements(e,t){const r=this.layer.effectiveSource;if(null==r)return[];this.view.featuresTilingScheme.getTileBounds($,e,!0);const s=new Y.A({xmin:$[0],ymin:$[1],xmax:$[2],ymax:$[3],spatialReference:this.view.spatialReference});return r.queryElements(s,t)}_referenceElements(e,t){if(null!=this.layer.source)for(const r of t)this._referenceElement(e,r)}_referenceElement(e,t){(0,o.tE)(this._elementReferences,t.uid,(()=>{const e=new m._({element:t,spatialReference:this.view.spatialReference}),r=new U(e);this._overlayContainer.addChild(r),this.elements.add(t);let s=null;return{tiles:new Set,projectedElement:e,overlay:r,debugGraphic:s}})).tiles.add(e)}_dereferenceElements(e,t){for(const r of t)this._dereferenceElement(e,r)}_dereferenceElement(e,t){const r=this._elementReferences.get(t.uid);r.tiles.delete(e),r.tiles.size||(this._overlayContainer.removeChild(r.overlay),r.overlay.destroy(),r.projectedElement.destroy(),this._elementReferences.delete(t.uid),this.elements.remove(t),this._debugGraphicsView?.graphics.remove(r.debugGraphic))}_elementUpdateHandler(e){let t=this._elementReferences.get(e.uid);if(t){const r=t.projectedElement.normalizedCoords;if(null==r)return this._overlayContainer.removeChild(t.overlay),t.overlay.destroy(),t.projectedElement.destroy(),this._elementReferences.delete(e.uid),this.elements.remove(e),void this._debugGraphicsView?.graphics.remove(t.debugGraphic);const s=[],n=[];for(const e of this._tileStrategy.tiles){const i=K(this.view.featuresTilingScheme,e,r);t.tiles.has(e)?i||n.push(e):i&&s.push(e)}for(const t of s)this._referenceElement(t,e);for(const t of n)this._dereferenceElement(t,e);return t=this._elementReferences.get(e.uid),void(t?.debugGraphic&&(t.debugGraphic.geometry=t.projectedElement.normalizedCoords,this._debugGraphicsView.graphicUpdateHandler({graphic:t.debugGraphic,property:"geometry"})))}const r=new m._({element:e,spatialReference:this.view.spatialReference}).normalizedCoords;if(null!=r)for(const s of this._tileStrategy.tiles)K(this.view.featuresTilingScheme,s,r)&&this._referenceElement(s,e)}};(0,s._)([(0,c.MZ)()],N.prototype,"_fetchQueue",void 0),(0,s._)([(0,c.MZ)()],N.prototype,"layer",void 0),(0,s._)([(0,c.MZ)({readOnly:!0})],N.prototype,"elements",void 0),N=(0,s._)([(0,h.$)("geoscene.views.2d.layers.MediaLayerView2D")],N);const $=(0,u.vt)(),J={xmin:0,ymin:0,xmax:0,ymax:0};function K(e,t,r){return e.getTileBounds($,t.key,!0),J.xmin=$[0],J.ymin=$[1],J.xmax=$[2],J.ymax=$[3],(0,p.fA)(J,r)}class X{constructor(e){this.key=e,this.elements=null,this.isReady=!1,this.visible=!0}setElements(e){const t=[],r=new Set(this.elements);this.elements=e;for(const s of e)r.has(s)?r.delete(s):t.push(s);return this.isReady=!0,[t,Array.from(r)]}destroy(){}}const ee=N}}]);
//# sourceMappingURL=2614.1a864ed6.js.map